<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS Master - v30 Cloud ‚òÅÔ∏è</title>
<meta name="theme-color" content="#00897B">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inconsolata:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #00897B; 
    --primary-dark: #00695C;
    --bg-app: #F4F6F8;
    --bg-white: #ffffff;
    --text-dark: #1f2937;
    --text-grey: #6b7280;
    --accent: #FF6F00;
    --danger: #D32F2F;
    --success: #388E3C;
    --font: "Poppins", sans-serif;
    --mono: "Inconsolata", monospace;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  }

  * { box-sizing: border-box; outline: none; }
  body { margin: 0; font-family: var(--font); background: var(--bg-app); color: var(--text-dark); height: 100vh; overflow: hidden; }
  .app { display: flex; height: 100%; }
  input, select, textarea { font-family: var(--font); }

  /* TOAST NOTIFICATIONS */
  #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; }
  .toast { background: rgba(30,30,30,0.9); color: white; padding: 12px 24px; border-radius: 50px; margin-top: 10px; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 10px; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.cloud { background: #2196F3; }

  /* SIDEBAR */
  .sidebar { width: 240px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; transition: background 0.3s; }
  .brand { font-size: 22px; font-weight: 700; margin-bottom: 40px; line-height: 1.2; }
  .nav-menu { flex: 1; display:flex; flex-direction:column; gap:5px; }
  .side-btn { background: transparent; border: none; color: rgba(255,255,255,0.8); width: 100%; text-align: left; padding: 12px 16px; border-radius: 12px; margin-bottom: 0; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
  .side-btn:hover { background: rgba(255,255,255,0.1); color: white; }
  .side-btn.active { background: rgba(0,0,0,0.2); color: white; font-weight: 600; }
  .logout-btn { margin-top: auto; color: white; cursor: pointer; opacity: 0.9; font-size: 14px; display: flex; gap: 10px; }
  .role-hidden { display: none !important; }

  /* MAIN AREA */
  .main { flex: 1; overflow: hidden; position: relative; display: flex; }
  
  /* POS LAYOUT & TABS */
  #POS { display: flex; width: 100%; height: 100%; }
  .pos-catalog { flex: 1; padding: 24px 32px; overflow-y: auto; display: flex; flex-direction: column; }
  .pos-cart { width: 360px; background: var(--bg-white); display: flex; flex-direction: column; padding: 0; box-shadow: -4px 0 15px rgba(0,0,0,0.05); z-index: 10; border-left: 1px solid #eee; }
  
  .ticket-tabs { display: flex; overflow-x: auto; background: #f3f4f6; padding: 10px 10px 0 10px; gap: 5px; border-bottom: 1px solid #e5e7eb; }
  .ticket-tab { background: #e5e7eb; padding: 8px 15px; border-radius: 8px 8px 0 0; font-size: 12px; font-weight: 600; color: #6b7280; cursor: pointer; min-width: 80px; text-align: center; position: relative; bottom: -1px; border:1px solid transparent; }
  .ticket-tab.active { background: white; color: var(--primary); border-color: #e5e7eb; border-bottom-color: white; z-index: 2; }
  .ticket-tab-add { background: transparent; border: none; font-size: 18px; color: #6b7280; cursor: pointer; padding: 0 10px; }
  .ticket-tab-close { font-size: 10px; margin-left: 5px; color: #999; padding: 2px; border-radius: 50%; }
  .ticket-tab-close:hover { background: #ffcdd2; color: #d32f2f; }

  .cart-content { padding: 24px; display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .cart-items-list { flex: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
  
  /* PRODUCTS */
  .search-bar-container { background: var(--bg-white); border-radius: var(--radius); padding: 8px 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; margin-bottom: 20px; border: 1px solid transparent; transition:0.2s; }
  .search-bar-container:focus-within { border-color:var(--primary); }
  .search-bar-container input { border: none; width: 100%; font-size: 15px; height: 40px; }
  
  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; padding-bottom: 40px; }
  .product-card { background: var(--bg-white); border-radius: var(--radius); padding: 10px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; border: 2px solid transparent; position:relative; overflow: hidden; }
  .product-card:hover { transform: translateY(-4px); border-color: var(--primary); }
  .product-card.low-stock { border-color: var(--danger); background: #FFEBEE; }
  .low-stock-badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }

  .prod-img-container { width: 100%; height: 120px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border-radius: 8px; overflow: hidden; background: #f9f9f9; }
  .prod-img { width: 100%; height: 100%; object-fit: contain; }
  .prod-icon { font-size: 40px; } 
  .prod-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 34px; }
  .prod-price { font-weight: 700; font-size: 16px; margin-top: auto; color: var(--primary-dark); }

  /* CART ITEMS */
  .cart-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f3f4f6; }
  .cart-info { flex: 1; }
  .cart-name { font-weight: 600; font-size: 13px; color: var(--text-dark); display: block; }
  .cart-price { font-size: 12px; color: var(--text-grey); }
  .qty-control { display: flex; align-items: center; gap: 8px; background: #f3f4f6; padding: 4px; border-radius: 8px; margin-right: 10px; }
  .qty-btn { width: 24px; height: 24px; border-radius: 6px; border: none; background: white; color: var(--text-dark); cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: 0.2s; }
  .qty-btn:hover { background: var(--primary); color: white; }
  .qty-val { font-size: 13px; font-weight: 600; min-width: 20px; text-align: center; }
  .cart-total-item { font-weight: 700; font-size: 14px; color: var(--primary-dark); min-width: 60px; text-align: right; }
  .cart-btn-remove { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 18px; padding: 0 0 0 8px; }
  
  /* BUTTONS */
  .pay-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
  .pay-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
  .pay-method-btn { flex:1; padding:12px; border:1px solid #ddd; background:white; border-radius:8px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; }
  .pay-method-btn.active { border-color:var(--primary); background:#E0F2F1; color:var(--primary-dark); }
  .btn-red { background: var(--danger); color: white; } .btn-red:hover { background: #b71c1c; }
  .btn-green { background: var(--success); color: white; } .btn-green:hover { background: #2E7D32; }

  /* GENERIC */
  .page-container { padding: 32px; width: 100%; height:100%; overflow-y: auto; display: none; background: var(--bg-app); }
  .page-title { font-size: 24px; font-weight: 700; margin-bottom: 24px; color: var(--text-dark); display:flex; align-items:center; gap:10px; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
  .btn-ghost { background: white; border: 1px solid #ddd; color: var(--text-dark); }
  .btn-icon { padding: 6px; width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display:inline-flex; align-items:center; justify-content:center; }
  .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 24px; }
  .option-card { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; text-align: center; aspect-ratio: 1/0.8; justify-content: center; border: 2px solid transparent; }
  .option-card:hover { border-color: var(--primary); transform: translateY(-4px); }
  .option-icon { font-size: 36px; margin-bottom: 12px; }
  .option-title { font-weight: 600; font-size: 16px; }
  .option-desc { font-size:12px; color:#888; margin-top:5px; }

  /* TABLES & INVENTORY TOOLBAR */
  .inv-toolbar { display:flex; gap:10px; margin-bottom:20px; align-items:center; background:white; padding:10px; border-radius:12px; box-shadow:var(--shadow); }
  .inv-table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); overflow-x: auto; min-height: 400px; }
  table { width: 100%; border-collapse: collapse; min-width: 900px; }
  thead tr { text-align: left; border-bottom: 2px solid #eee; }
  th { padding: 14px 10px; font-weight: 600; color: var(--text-grey); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; vertical-align: middle; }
  .tag-type { background: #F3E5F5; color: #7B1FA2; font-size: 11px; padding: 2px 6px; border-radius: 4px; }

  /* CLIENTES */
  .client-card { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
  .client-card.debtor { border-left-color: var(--danger); }
  .client-card.clean { border-left-color: var(--success); }
  .client-balance { font-size: 18px; font-weight: 700; }
  .client-balance.debt { color: var(--danger); }
  .detail-table { width:100%; border-collapse:collapse; margin-bottom:15px; }
  .detail-table td { padding:8px; font-size:13px; border-bottom:1px solid #eee; }
  .detail-table tr:last-child td { border-bottom:none; }

  /* REPORTES & GRAFICAS */
  .caja-resumen-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
  .caja-card-big { background: white; border-radius: 16px; padding: 25px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; border-left: 6px solid #ddd; }
  .caja-val { font-size: 32px; font-weight: 700; color: var(--text-dark); margin-top: 5px; }
  .caja-lbl { font-size: 13px; font-weight: 600; color: var(--text-grey); text-transform: uppercase; letter-spacing: 0.5px; }
  .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px; }
  .chart-date-label { font-size: 14px; color: var(--primary); font-weight: 600; background: #E0F2F1; padding: 5px 12px; border-radius: 20px; }
  .chart-tabs { display:flex; background:#f3f4f6; padding:4px; border-radius:20px; gap:2px; }
  .chart-tab { padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; border:none; cursor:pointer; background:transparent; color:#666; transition:0.2s; }
  .chart-tab:hover { color:var(--primary); }
  .chart-tab.active { background:white; color:var(--primary); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  .bar-chart { display:flex; align-items:flex-end; gap:10px; height:200px; padding-top:20px; }
  .bar-group { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:flex-end; }
  .bar { width:100%; background:var(--primary); border-radius:6px 6px 0 0; transition:height 0.5s; min-height:4px; position:relative; }
  .bar-val { position:absolute; top:-20px; width:100%; text-align:center; font-size:11px; font-weight:bold; color:#666; }
  .bar-label { margin-top:8px; font-size:11px; color:#888; text-align:center; }

  /* PREDICTIONS CARD */
  .pred-card { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: var(--shadow); border-left: 5px solid #ccc; }
  .pred-card.crit { border-left-color: var(--danger); background: #FFEBEE; }
  .pred-card.warn { border-left-color: var(--accent); background: #FFF8E1; }
  .pred-card.ok { border-left-color: var(--success); }
  .pred-info h4 { margin:0; font-size:15px; }
  .pred-info p { margin:4px 0 0 0; font-size:12px; color:#666; }
  .pred-stat { text-align: right; }
  .pred-stat .days { font-size: 18px; font-weight: 700; }
  .pred-stat .label { font-size: 10px; text-transform: uppercase; opacity: 0.7; }

  /* SETTINGS */
  .settings-section { background:white; padding:25px; border-radius:16px; box-shadow:var(--shadow); margin-bottom:25px; }
  .settings-section h3 { margin-top:0; color:var(--primary-dark); border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px; }
  .users-table { width:100%; border-collapse:collapse; margin-top:15px; }
  .users-table th { text-align:left; padding:10px; background:#f9f9f9; color:#666; font-size:12px; }
  .users-table td { padding:10px; border-bottom:1px solid #eee; font-size:14px; }

  /* MODALS */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
  .modal-content { background: white; padding: 28px; border-radius: 16px; width: 95%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.2s ease-out; max-height: 90vh; overflow-y: auto; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 20px; color: var(--primary-dark); }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-grey); }
  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; transition: 0.2s; }
  
  /* IMPORTADOR */
  .file-drop-zone { border: 2px dashed #ddd; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white; }
  .mapping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
  #imgPreview { width: 80px; height: 80px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; display: block; }

  /* === TICKET PRINTER STYLE (58mm) === */
  #printableTicket { display: none; width: 58mm; font-family: var(--mono); font-size: 12px; color: black; background: white; padding: 5px; }
  .t-header { text-align: center; margin-bottom: 10px; }
  .t-line { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .t-divider { border-top: 1px dashed black; margin: 8px 0; }
  .t-bold { font-weight: bold; }
  .t-center { text-align: center; }
  .t-logo { max-width: 100%; height: auto; display: block; margin: 0 auto 10px auto; filter: grayscale(100%) contrast(150%); }
  
  @media print {
    .app, .modal-overlay { display: none !important; }
    #printableTicket { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
    body { background: white; overflow: visible; height: auto; }
  }
</style>
</head>
<body>

<div id="toast-container"></div>

<div id="printableTicket"></div>

<div id="loginModal" class="modal-overlay"><div class="modal-content" style="max-width:350px"><h3>Iniciar Sesi√≥n</h3><div class="form-group"><label>Usuario</label><input id="loginUser" type="text" value="admin"></div><div class="form-group"><label>Contrase√±a</label><input id="loginPass" type="password" value="1234"></div><button class="pay-btn" onclick="handleLogin()">Entrar</button></div></div>

<div id="cashModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:350px"><h3>Apertura de Caja</h3><div class="form-group"><label>Monto Inicial (Fondo)</label><input id="initialCash" type="number" placeholder="0.00"></div><button class="pay-btn" onclick="handleSetInitialCash()">Iniciar Turno</button></div></div>

<div id="chargeModal" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:400px">
        <h3>Procesar Pago</h3>
        <div style="text-align:center; margin-bottom:15px"><div style="font-size:13px; color:#666">Total a Pagar</div><div id="chargeTotalLabel" style="font-size:36px; font-weight:700; color:var(--primary); line-height:1">$0.00</div></div>
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <button id="btnCash" class="pay-method-btn active" onclick="setPaymentMethod('efectivo')">üíµ Efectivo</button>
            <button id="btnCard" class="pay-method-btn" onclick="setPaymentMethod('tarjeta')">üí≥ Tarjeta</button>
            <button id="btnCredit" class="pay-method-btn" style="border-color:var(--accent); color:var(--accent)" onclick="setPaymentMethod('credito')">ü§ù Cr√©dito</button>
        </div>
        <div id="creditSection" style="display:none; margin-bottom:15px; background:#FFF8E1; padding:10px; border-radius:8px"><label style="font-size:12px; font-weight:bold">Seleccionar Cliente:</label><select id="creditClientSel" style="width:100%; margin-top:5px"></select><button class="btn btn-ghost" style="width:100%; margin-top:5px; font-size:11px" onclick="showPage('Clientes'); closeCobrarModal()">+ Nuevo Cliente</button></div>
        <div class="form-group" id="cashInputGroup"><label>Efectivo Recibido</label><input id="chargeCashInput" type="number" placeholder="Monto recibido" oninput="calcChange()" style="font-size:20px; font-weight:bold; text-align:center; color:#1f2937"></div>
        <div style="text-align:center; font-weight:600; margin-bottom:20px; font-size:18px; color:#333" id="chargeChangeLabel">Cambio: $0.00</div>
        <div style="display:flex; flex-direction:column; gap:10px"><button class="pay-btn" onclick="finalizeSale(true)">üñ®Ô∏è Cobrar e Imprimir (F12)</button><button class="btn btn-ghost" style="background:#f1f5f9; border:none; color:#475569" onclick="finalizeSale(false)">‚úÖ Cobrar SIN Imprimir (F2)</button><button class="btn btn-ghost" onclick="closeCobrarModal()">Cancelar (Esc)</button></div>
    </div>
</div>

<div id="stockWarningModal" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:350px; text-align:center">
        <h3 style="color:var(--danger)">‚ö†Ô∏è Stock Agotado</h3>
        <p>El producto <b><span id="swName"></span></b> tiene <b id="swQty">0</b> en inventario.</p>
        <div class="form-group" style="margin-top:15px"><label>Agregar al Stock Ahora:</label><input id="swAdd" type="number" placeholder="0" style="font-size:18px; text-align:center"></div>
        <button class="pay-btn" onclick="resolveStockWarning()">Surtir y Vender</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="ignoreStockWarning()">Vender sin Stock</button>
    </div>
</div>

<div id="quickAddProductModal" class="modal-overlay" style="display:none">
    <div class="modal-content" style="max-width:350px">
        <h3>‚ú® Producto Nuevo</h3>
        <p>El c√≥digo <b><span id="qaCode"></span></b> no existe.</p>
        <div class="form-group"><label>Nombre</label><input id="qaName"></div>
        <div class="form-group"><label>Precio Venta</label><input id="qaPrice" type="number"></div>
        <button class="pay-btn" onclick="saveQuickProduct()">Guardar y Vender</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="document.getElementById('quickAddProductModal').style.display='none'">Cancelar</button>
    </div>
</div>

<div id="abonoModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:350px"><h3>Abonar a Cuenta</h3><div style="margin-bottom:15px">Cliente: <b id="abonoClientName"></b></div><div style="margin-bottom:15px; color:var(--danger)">Deuda Actual: <b id="abonoCurrentDebt">$0.00</b></div><div class="form-group"><label>Monto a Abonar ($)</label><input id="abonoAmount" type="number" style="font-size:20px; font-weight:bold"></div><button class="pay-btn" onclick="processAbono()">Registrar Abono</button><button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="document.getElementById('abonoModal').style.display='none'">Cancelar</button></div></div>
<div id="clientDetailModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:450px"><h3>Resumen de Deuda</h3><div style="margin-bottom:15px">Cliente: <b id="detailClientName"></b></div><div style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:15px" id="detailList"></div><div style="text-align:right; font-weight:bold; font-size:18px; color:var(--danger)" id="detailTotal">Total: $0.00</div><div style="display:flex; gap:10px; margin-top:20px"><button class="btn btn-ghost" style="background:#FFEBEE; color:#D32F2F; flex:1" onclick="manualClearHistory()">üóëÔ∏è Borrar/Perdonar Deuda</button><button class="btn btn-ghost" style="flex:1" onclick="document.getElementById('clientDetailModal').style.display='none'">Cerrar</button></div></div></div>

<div id="commonItemModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:300px"><h3>Producto Com√∫n</h3><div class="form-group"><label>Precio</label><input id="commonPrice" type="number" style="font-size:24px; text-align:center" onkeydown="if(event.key==='Enter') confirmCommonItem()"></div><button class="pay-btn" onclick="confirmCommonItem()">Agregar</button></div></div>

<div id="autoCreditModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:350px; border:2px solid var(--accent)"><h3>‚ö†Ô∏è Ticket Abierto</h3><p>Para cerrar turno, el ticket <b>"<span id="acTicketName"></span>"</b> debe asignarse a un cliente.</p><div class="form-group"><label>Cliente</label><select id="acClientSel"></select></div><button class="pay-btn" onclick="confirmAutoCredit()">Guardar como Deuda</button><button class="btn btn-ghost" style="width:100%; margin-top:10px; color:#666" onclick="document.getElementById('autoCreditModal').style.display='none'">Cancelar / Volver</button></div></div>
<div id="supplierModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:400px"><h3>üöõ Recepci√≥n</h3><div class="form-group"><label>C√≥digo</label><input id="supCode" placeholder="Escanear..." onkeydown="if(event.key==='Enter') handleSupplierScan()"></div><div id="supInfo" style="display:none; border:1px solid #eee; padding:15px; border-radius:8px; margin-bottom:15px"><div style="font-weight:bold" id="supName"></div><div class="form-group"><label>Cantidad (+)</label><input id="supQty" type="number" onkeydown="if(event.key==='Enter') saveSupplierAdd()"></div><button class="pay-btn" onclick="saveSupplierAdd()">‚úÖ Confirmar</button></div><button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('supplierModal').style.display='none'">Cerrar</button></div></div>
<div id="moveModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:350px"><h3>Movimiento</h3><div class="form-group"><div style="display:flex; gap:10px"><button id="btnIn" class="pay-method-btn" onclick="setMoveType('entrada')">üü¢ Entrada</button><button id="btnOut" class="pay-method-btn" onclick="setMoveType('salida')">üî¥ Salida</button></div></div><div class="form-group"><label>Monto</label><input id="moveAmount" type="number"></div><div class="form-group"><label>Motivo</label><input id="moveReason"></div><button class="pay-btn" onclick="confirmMovement()">Guardar</button><button class="btn btn-ghost" style="width:100%" onclick="closeMoveModal()">Cancelar</button></div></div>
<div id="endShiftModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:450px"><h3>üèÅ Corte de Caja</h3><div class="form-group"><div class="t-line"><span>Fondo:</span><span id="cutInitial">$0.00</span></div><div class="t-line" style="color:var(--success)"><span>+ Ventas Efec:</span><span id="cutSales">$0.00</span></div><div class="t-line" style="color:var(--success)"><span>+ Entradas/Abonos:</span><span id="cutIn">$0.00</span></div><div class="t-line" style="color:var(--danger)"><span>- Gastos:</span><span id="cutOut">$0.00</span></div><div class="t-divider"></div><div class="t-line t-bold" style="font-size:18px"><span>DEBE HABER:</span><span id="cutFinal">$0.00</span></div></div><button class="pay-btn" onclick="printAndCloseShift()">üñ®Ô∏è Cerrar Turno y Salir</button><button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('endShiftModal').style.display='none'">Volver</button></div></div>
<div id="bulkModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>A Granel ‚öñÔ∏è</h3><div style="background:#F0F4C3;padding:10px;margin-bottom:10px"><strong id="bulkName"></strong><span id="bulkPrice"></span></div><input id="bulkQtyInput" type="number" placeholder="0.000" style="font-size:24px;text-align:center;width:100%;margin-bottom:10px" oninput="calcBulkTotal()"><div id="bulkTotalDisplay" style="text-align:center;font-weight:bold;margin-bottom:10px">Total: $0.00</div><button class="pay-btn" onclick="confirmBulkAdd()">Agregar</button></div></div>
<div id="editProductModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:500px"><h3>Editar</h3><div style="display:grid; grid-template-columns: 100px 1fr; gap:20px"><div style="text-align:center"><img id="imgPreview" src="" alt="Sin Foto" style="width:80px;height:80px;object-fit:contain"><button class="btn-ghost" style="font-size:10px" onclick="searchImageOnGoogle()">üîç Buscar</button></div><div><label>Imagen URL</label><input id="editImage" oninput="updateImgPreview()" style="width:100%"></div></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px"><input id="editCode" disabled><input id="editQty" type="number"><input id="editName" style="grid-column:span 2"><select id="editSaleType"><option value="Unidad">Unidad</option><option value="Granel">Granel</option></select><input id="editPrice" type="number"><input id="editDept"></div><div style="display:flex; gap:10px; margin-top:15px"><button class="pay-btn" onclick="saveProductChanges()">Guardar</button><button class="btn btn-ghost" onclick="closeEditModal()">Cancelar</button></div><button class="btn" style="width:100%; margin-top:15px; color:red" onclick="deleteProductFromModal()">Eliminar</button></div></div>

<div class="app">
  <aside class="sidebar">
    <div class="brand"><span id="brandNameDisplay">Abarrotes<br>Los Altos</span> <span style="font-size:10px; opacity:0.6">v30</span></div>
    <div class="nav-menu">
        <button class="side-btn active" onclick="showPage('POS')">üõí Ventas</button>
        <button class="side-btn" onclick="showPage('Clientes')">üë• Clientes</button>
        <button class="side-btn" onclick="showPage('Caja')">üí∞ Caja</button>
        <button class="side-btn" onclick="showPage('Reportes')">üìä Reportes</button>
        <button class="side-btn role-btn" onclick="showPage('Inventario')">üì¶ Inventario</button>
        <button class="side-btn role-btn" onclick="showPage('Opciones')">‚öôÔ∏è Opciones</button>
    </div>
    <div class="logout-btn" onclick="doLogout()">‚Ü™Ô∏è Cerrar Sesi√≥n</div>
  </aside>
  <main class="main">
    <div id="POS">
        <div class="pos-catalog">
            <div class="search-bar-container"><span>üîç</span><input type="text" id="catalogSearch" placeholder="Buscar (F10)..." onkeydown="checkSearchEnter(event)" onkeyup="renderCatalog()"></div>
            <div class="products-grid" id="productsGrid"></div>
        </div>
        <div class="pos-cart">
            <div class="ticket-tabs" id="ticketTabs"></div>
            <div class="cart-content">
                <h3 style="margin-top:0; margin-bottom:10px; font-size:14px; color:#666" id="activeTicketLabel">Ticket 1</h3>
                <div class="cart-items-list" id="cartList"></div>
                <div style="margin-top:auto; border-top:2px dashed #eee; padding-top:15px">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:flex-end"><span style="color:#666; font-size:14px">Total a pagar</span><span id="lblTotal" style="font-size:28px; font-weight:700; color:var(--text-dark)">$0.00</span></div>
                    <button class="pay-btn" onclick="openCobrarModal()">Cobrar (F12)</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="Clientes" class="page-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h2 class="page-title" style="margin:0">Cartera de Clientes</h2>
            <button class="btn btn-ghost" style="background:#E0F2F1; color:var(--primary)" onclick="document.getElementById('addClientForm').style.display='block'">+ Nuevo Cliente</button>
        </div>
        <div id="addClientForm" style="display:none; background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:var(--shadow)">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end">
                <div class="form-group" style="margin:0"><label>Nombre *</label><input id="newCliName"></div>
                <div class="form-group" style="margin:0"><label>Tel√©fono</label><input id="newCliPhone"></div>
                <div class="form-group" style="margin:0"><label>L√≠mite Cr√©dito</label><input id="newCliLimit" type="number" placeholder="0 = Sin limite"></div>
                <button class="pay-btn" style="padding:10px 20px" onclick="addClient()">Guardar</button>
            </div>
        </div>
        <div id="clientsList"></div>
    </div>

    <div id="Caja" class="page-container">
        <h2 class="page-title">Gesti√≥n de Caja</h2>
        <div class="caja-resumen-grid">
            <div class="caja-card-big" style="border-color:var(--primary)"><div class="caja-lbl">Ventas de Hoy</div><div class="caja-val" id="cajaVentasHoy">$0.00</div></div>
            <div class="caja-card-big" style="border-color:var(--success)"><div class="caja-lbl">Efectivo en Caja</div><div class="caja-val" id="cajaEfectivo">$0.00</div></div>
        </div>
        <div class="options-grid">
            <div class="option-card" onclick="openMoveModal()"><div class="option-icon">üìù</div><div class="option-title">Registrar Movimiento</div><div class="option-desc">Entradas o Salidas de efectivo</div></div>
            <div class="option-card" onclick="openEndShift()" style="border:2px solid var(--text-dark)"><div class="option-icon">üîê</div><div class="option-title">Corte de Caja</div><div class="option-desc">Imprimir balance y cerrar</div></div>
        </div>
    </div>

    <div id="Reportes" class="page-container">
        <h2 class="page-title">Reportes</h2>
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 style="margin:0">Tendencia de Ventas</h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="renderAnalytics('dia', this)">Hoy</button>
                        <button class="chart-tab" onclick="renderAnalytics('semana', this)">Semana</button>
                        <button class="chart-tab" onclick="renderAnalytics('mes', this)">Mes</button>
                    </div>
                </div>
                <div id="chartDateLabel" class="chart-date-label" style="margin-bottom:15px; text-align:center"></div>
                <div id="barChart" class="bar-chart"></div>
            </div>
            <div class="chart-card"><h3 style="margin-top:0">üèÜ Top Productos</h3><table class="users-table"><thead><tr><th>Producto</th><th style="text-align:right">Cant.</th><th style="text-align:right">Total</th></tr></thead><tbody id="topProductsList"></tbody></table></div>
        </div>
    </div>
    
    <div id="Opciones" class="page-container"><h2 class="page-title">Panel de Control</h2><div class="options-grid"><div class="option-card" onclick="showPage('Configuracion')"><div class="option-icon">‚öôÔ∏è</div><div class="option-title">Configuraci√≥n</div></div><div class="option-card" onclick="showPage('Importar')"><div class="option-icon">üì•</div><div class="option-title">Importar CSV</div></div><div class="option-card" onclick="exportInventory()"><div class="option-icon">üíæ</div><div class="option-title">Respaldo</div></div></div></div>
    <div id="Configuracion" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2 class="page-title">Configuraci√≥n</h2><button class="btn btn-ghost" onclick="showPage('Opciones')">‚Üê Volver</button></div><div class="options-grid"><div class="option-card" onclick="showPage('Cfg_Apariencia')"><div class="option-icon">üé®</div><div class="option-title">Apariencia</div></div><div class="option-card" onclick="showPage('Cfg_Ticket')"><div class="option-icon">üßæ</div><div class="option-title">Ticket</div></div><div class="option-card" onclick="showPage('Cfg_Usuarios')"><div class="option-icon">üë•</div><div class="option-title">Usuarios</div></div></div></div>
    <div id="Cfg_Apariencia" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2 class="page-title">üé® Apariencia</h2><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button></div><div class="settings-section"><div style="display:grid; grid-template-columns:1fr 1fr; gap:20px"><div class="form-group"><label>Nombre</label><input id="cfgBizName"></div><div class="form-group"><label>Color</label><input id="cfgColor" type="color" onchange="previewColor()"></div></div><button class="pay-btn" style="width:auto" onclick="saveConfig()">Guardar</button></div></div>
    <div id="Cfg_Ticket" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2 class="page-title">üßæ Ticket</h2><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button></div><div class="settings-section"><div class="form-group"><label>Logo URL</label><input id="cfgLogo"></div><div class="form-group"><label>Encabezado</label><textarea id="cfgHeader" rows="2"></textarea></div><div class="form-group"><label>Pie</label><textarea id="cfgFooter" rows="2"></textarea></div><button class="pay-btn" style="width:auto" onclick="saveConfig()">Guardar</button></div></div>
    <div id="Cfg_Usuarios" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2 class="page-title">üë• Usuarios</h2><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button></div><div class="settings-section"><div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:15px; background:#f9f9f9; padding:15px; border-radius:8px"><div class="form-group" style="margin:0; flex:1"><label>Usuario</label><input id="newUserName"></div><div class="form-group" style="margin:0; flex:1"><label>Contrase√±a</label><input id="newUserPass"></div><div class="form-group" style="margin:0; width:120px"><label>Rol</label><select id="newUserRole"><option value="cajero">Cajero</option><option value="admin">Admin</option></select></div><button class="pay-btn" style="width:auto; padding:10px 20px" onclick="addUser()">+ Agregar</button></div><table class="users-table"><thead><tr><th>Usuario</th><th>Rol</th><th>Acci√≥n</th></tr></thead><tbody id="usersList"></tbody></table></div></div>
    
    <div id="Inventario" class="page-container"><div class="inv-toolbar"><h2 class="page-title" style="margin:0; margin-right:15px">Inventario</h2><div style="flex:1; display:flex; gap:10px"><input id="invSearch" type="text" placeholder="Buscar..." onkeyup="currentInvPage=1; renderInvTable()" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px"><select id="filterDept" onchange="currentInvPage=1; renderInvTable()" style="width:150px"><option value="">Todos Deptos</option></select></div><button class="btn btn-ghost" style="background:#E1F5FE; color:#0277BD; border:none; margin-left:10px" onclick="openSupplierModal()">üöõ Recepci√≥n Proveedor</button><button class="btn btn-ghost" style="background:#F3E5F5; color:#7B1FA2; border:none" onclick="showPage('Prediccion')">üîÆ Smart Supply</button></div><div class="inv-table-container"><table id="invTable"><thead><tr><th>Acci√≥n</th><th>C√≥digo</th><th>Producto</th><th>Costo</th><th>Venta</th><th>Depto</th><th>Stock</th></tr></thead><tbody></tbody></table></div><div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-top:20px"><button class="btn btn-ghost" onclick="prevPage()">‚óÄ</button><span id="pageIndicator" style="font-size:14px; font-weight:600; color:#666">1</span><button class="btn btn-ghost" onclick="nextPage()">‚ñ∂</button></div></div>
    <div id="Prediccion" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2 class="page-title">üîÆ Predicci√≥n de Abasto (IA)</h2><button class="btn btn-ghost" onclick="showPage('Inventario')">‚Üê Volver</button></div><div id="predictionList"></div></div>
    <div id="Importar" class="page-container"><button class="btn btn-ghost" onclick="showPage('Opciones')">‚Üê Volver</button><h2 class="page-title">Importar</h2><div class="file-drop-zone" onclick="document.getElementById('csvFileInput').click()">üìÑ Clic para subir CSV<input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)"></div><div id="mappingSection" style="display:none; margin-top:30px; background:white; padding:25px; border-radius:16px; box-shadow:var(--shadow)"><h3>Relacionar Columnas</h3><div class="mapping-grid"><div class="form-group"><label>C√≥digo *</label><select id="map-code"></select></div><div class="form-group"><label>Nombre *</label><select id="map-name"></select></div><div class="form-group"><label>P. Venta *</label><select id="map-price"></select></div><div class="form-group"><label>Tipo de Venta</label><select id="map-saleType"></select></div><div class="form-group"><label>Stock</label><select id="map-qty"></select></div><div class="form-group"><label>P. Costo</label><select id="map-cost"></select></div><div class="form-group"><label>Depto</label><select id="map-dept"></select></div></div><button class="pay-btn" style="width:auto; margin-top:20px" onclick="processImport()">Importar</button></div></div>
  </main>
</div>

<script>
/* ================= FIREBASE CONFIGURATION ================= */
// --- 1. PEGA TUS CLAVES DE FIREBASE AQU√ç ---
const firebaseConfig = {
  apiKey: "AIzaSyA61-NvaXsIqCJAlkYockyhNOn9jBfq4d0",
  authDomain: "posmaster-b7ee3.firebaseapp.com",
  projectId: "posmaster-b7ee3",
  storageBucket: "posmaster-b7ee3.appspot.com",
  messagingSenderId: "218428018122",
  appId: "1:218428018122:web:c32565fde06f2ba3fc9333"
};

// Initialize Firebase
let dbFire = null;
if(firebaseConfig.apiKey !== "AIzaSyA61-NvaXsIqCJAlkYockyhNOn9jBfq4d0") {
    firebase.initializeApp(firebaseConfig);
    dbFire = firebase.firestore();
}

/* ================= HELPERS & TOAST ================= */
function showToast(msg, type='neutral') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = type==='success' ? '‚úÖ '+msg : type==='error' ? '‚ùå '+msg : msg; c.appendChild(t); requestAnimationFrame(() => t.classList.add('show')); setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, 3000); }
function smartFormatName(n) { if(!n)return""; return n.replace(/[._]/g,' ').replace(/\s+/g,' ').trim().toLowerCase().replace(/(?:^|\s)\S/g, a=>a.toUpperCase()); }
function applySmartName() { const i=document.getElementById('editName'); i.value=smartFormatName(i.value); }
function getSmartEmoji(n) { const l=n.toLowerCase(); if(l.includes('coca')||l.includes('pepsi'))return 'ü•§'; if(l.includes('leche'))return 'ü•õ'; if(l.includes('jabon')||l.includes('cloro'))return 'üßº'; if(l.includes('papas'))return 'üçü'; if(l.includes('cerveza'))return 'üç∫'; if(l.includes('jamon'))return 'ü•©'; return 'üì¶'; }
function searchImageOnGoogle() { const name = document.getElementById('editName').value; if(!name) return showToast('Escribe un nombre', 'error'); window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name)}`, '_blank'); }
function updateImgPreview() { const url = document.getElementById('editImage').value; const img = document.getElementById('imgPreview'); img.style.display = 'block'; img.src = url; }
function adjustColor(color, amount) { return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)); }

/* ================= BASE DE DATOS (HYBRID) ================= */
const MAIN_KEY = 'abarrotes_master_db';
const LEGACY_KEYS = ['abarrotes_pos_v17', 'abarrotes_pos_permanent'];
const db_defaults = { 
    products: [], sales: [], movements: [], clients: [], 
    activeTickets: [{ id: 1, name: 'Ticket 1', items: [] }],
    users: [{name:'admin', pass:'1234', role:'admin'}], 
    config: { bizName: 'Abarrotes Los Altos', color: '#00897B', ticketHeader: 'Colima, Manzanillo\nTel: 314-000-0000', ticketFooter: '¬°Gracias por su compra!', logo: '' }, 
    session: { user: null, role: null, cash: null, currentTicketId: 1 } 
};
let db = { ...db_defaults }, g_csvData = [], currentInvPage = 1;
const itemsPerPage = 50; let currentPaymentMethod = 'efectivo'; let pendingBulkCode = null; let currentMoveType = 'entrada'; let abonoClientId = null; let pendingAddStockCode = null;

// LOAD DB: Local first, then Cloud
async function loadDB() {
    let raw = localStorage.getItem(MAIN_KEY);
    if (!raw) { for (const oldKey of LEGACY_KEYS) { const oldData = localStorage.getItem(oldKey); if (oldData) { raw = oldData; break; } } }
    if(raw) { 
        try { 
            const saved = JSON.parse(raw); 
            // Merge defaults
            db = { ...db_defaults, ...saved, 
                config: { ...db_defaults.config, ...(saved.config || {}) }, 
                users: (saved.users && saved.users.length > 0) ? saved.users : db_defaults.users, 
                session: { ...db_defaults.session, ...saved.session } // Keep local session data
            }; 
            if(!db.activeTickets || db.activeTickets.length===0) db.activeTickets = [{id:1, name:'Ticket 1', items:[]}];
            if(!db.clients) db.clients = [];
            initAppUI();
        } catch(e) { console.error("Error local DB", e); } 
    } else { initAppUI(); }

    // SYNC WITH CLOUD
    if(dbFire) {
        try {
            const docRef = dbFire.collection("tiendas").doc("mi_sucursal");
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const cloudData = docSnap.data();
                const currentSession = db.session; // Preserve local session
                db = { ...db_defaults, ...cloudData };
                db.session = currentSession;
                localStorage.setItem(MAIN_KEY, JSON.stringify(db));
                showToast("‚òÅÔ∏è Datos sincronizados", "cloud");
                // Refresh UI
                renderCatalog(); renderTabs(); renderCart(); applyConfigUI();
            } else {
                saveDB(); // Create cloud copy
            }
        } catch(e) { console.error("Error cloud", e); }
    }
}

function saveDB() { 
    localStorage.setItem(MAIN_KEY, JSON.stringify(db));
    if(dbFire) {
        const cleanDB = JSON.parse(JSON.stringify(db));
        dbFire.collection("tiendas").doc("mi_sucursal").set(cleanDB).catch(e=>console.error(e));
    }
}

function initAppUI() {
    applyConfigUI();
    if(!db.session.user) { 
        document.getElementById('loginModal').style.display='flex'; 
    } else { 
        if(!db.session.role) db.session.role = 'admin'; 
        checkRoleUI(db.session.role); 
        if(!db.session.cash) document.getElementById('cashModal').style.display='flex'; 
        else { renderCatalog(); renderTabs(); renderCart(); setupKeyboard(); }
    }
}

window.onload = () => { loadDB(); };

/* ================= SHORTCUTS ================= */
function setupKeyboard() {
    document.addEventListener('keydown', (e) => {
        if(e.key === 'F10') { e.preventDefault(); document.getElementById('catalogSearch').focus(); }
        if(e.key === 'F12') { e.preventDefault(); if(document.getElementById('chargeModal').style.display === 'none') openCobrarModal(); else finalizeSale(true); }
        if(e.key === 'F9') { e.preventDefault(); document.getElementById('commonItemModal').style.display='flex'; setTimeout(()=>document.getElementById('commonPrice').focus(),100); }
        if(e.key === 'F2' && document.getElementById('chargeModal').style.display === 'flex') { e.preventDefault(); finalizeSale(false); }
        if(e.key === 'Escape') { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
    });
}

function handleLogin() { const u = document.getElementById('loginUser').value; const p = document.getElementById('loginPass').value; const user = db.users.find(x => x.name === u && x.pass === p); if(user) { db.session.user = user.name; db.session.role = user.role; saveDB(); document.getElementById('loginModal').style.display='none'; checkRoleUI(user.role); if(!db.session.cash) document.getElementById('cashModal').style.display='flex'; else { renderCatalog(); renderTabs(); renderCart(); setupKeyboard(); } } else { showToast('Usuario incorrecto', 'error'); } }
function doLogout() { db.session.user = null; saveDB(); location.reload(); }
function checkRoleUI(role) { const disp = (role === 'cajero') ? 'none' : 'flex'; document.querySelectorAll('.role-btn').forEach(e => e.style.display = disp); }
function handleSetInitialCash() { db.session.cash = document.getElementById('initialCash').value; saveDB(); document.getElementById('cashModal').style.display='none'; renderCatalog(); renderTabs(); renderCart(); setupKeyboard(); }

/* ================= SETTINGS ================= */
function applyConfigUI() { const c = db.config; document.documentElement.style.setProperty('--primary', c.color); document.documentElement.style.setProperty('--primary-dark', adjustColor(c.color, -30)); document.getElementById('brandNameDisplay').innerHTML = c.bizName.replace(/\n/g,'<br>'); document.getElementById('cfgBizName').value = c.bizName; document.getElementById('cfgColor').value = c.color; document.getElementById('cfgHeader').value = c.ticketHeader; document.getElementById('cfgFooter').value = c.ticketFooter; document.getElementById('cfgLogo').value = c.logo || ''; }
function previewColor() { const color = document.getElementById('cfgColor').value; document.documentElement.style.setProperty('--primary', color); }
function saveConfig() { db.config.bizName = document.getElementById('cfgBizName').value; db.config.color = document.getElementById('cfgColor').value; db.config.ticketHeader = document.getElementById('cfgHeader').value; db.config.ticketFooter = document.getElementById('cfgFooter').value; db.config.logo = document.getElementById('cfgLogo').value; saveDB(); applyConfigUI(); showToast('Guardado', 'success'); }

function showPage(id) { 
    document.querySelectorAll('.page-container, #POS').forEach(e=>e.style.display='none'); 
    document.getElementById(id).style.display=id==='POS'?'flex':'block'; 
    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
    if(id==='Inventario'){ currentInvPage=1; populateDeptFilter(); renderInvTable(); }
    if(id==='Reportes'){ renderAnalytics('dia'); }
    if(id==='Caja'){ renderCajaDashboard(); }
    if(id==='Clientes'){ renderClients(); }
    if(id==='Prediccion'){ runPredictions(); }
    if(id.startsWith('Cfg_') || id==='Configuracion'){ applyConfigUI(); }
}

/* ================= TABS & CART ================= */
function getCurrentTicket() { let t = db.activeTickets.find(t => t.id === db.session.currentTicketId); if(!t) { t = db.activeTickets[0]; db.session.currentTicketId = t.id; } return t; }
function renderTabs() { const c = document.getElementById('ticketTabs'); c.innerHTML = ''; db.activeTickets.forEach(t => { const isActive = t.id === db.session.currentTicketId; const div = document.createElement('div'); div.className = `ticket-tab ${isActive?'active':''}`; div.innerHTML = `<span ondblclick="renameTab(${t.id})">${t.name}</span> ${db.activeTickets.length>1 ? `<span class="ticket-tab-close" onclick="closeTab(${t.id}, event)">‚úï</span>` : ''}`; div.onclick = (e) => { if(!e.target.classList.contains('ticket-tab-close')) { db.session.currentTicketId = t.id; saveDB(); renderTabs(); renderCart(); } }; c.appendChild(div); }); const addBtn = document.createElement('button'); addBtn.className = 'ticket-tab-add'; addBtn.innerText = '+'; addBtn.onclick = () => { const newId = Date.now(); db.activeTickets.push({id: newId, name: `Ticket ${db.activeTickets.length+1}`, items: []}); db.session.currentTicketId = newId; saveDB(); renderTabs(); renderCart(); }; c.appendChild(addBtn); }
function renameTab(id) { const t = db.activeTickets.find(x=>x.id===id); const newName = prompt('Nombre del Ticket:', t.name); if(newName){ t.name = newName; saveDB(); renderTabs(); } }
function closeTab(id, e) { e.stopPropagation(); const idx = db.activeTickets.findIndex(x=>x.id===id); if(db.activeTickets[idx].items.length > 0) return showToast('Ticket con productos.','error'); db.activeTickets.splice(idx,1); db.session.currentTicketId = db.activeTickets[db.activeTickets.length-1].id; saveDB(); renderTabs(); renderCart(); }

/* ================= POS LOGIC ================= */
function renderCatalog() { const grid = document.getElementById('productsGrid'); grid.innerHTML = ''; const term = document.getElementById('catalogSearch').value.toLowerCase(); const filtered = db.products.filter(p => p.name.toLowerCase().includes(term) || p.code.includes(term)).slice(0, 50); filtered.forEach(p => { const div = document.createElement('div'); div.className = `product-card ${p.qty<=1?'low-stock':''}`; div.onclick = () => checkStockAndAdd(p); let visual = (p.image && p.image.length > 10) ? `<img src="${p.image}" class="prod-img" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="prod-icon" style="display:none">${getSmartEmoji(p.name)}</div>` : `<div class="prod-icon">${getSmartEmoji(p.name)}</div>`; div.innerHTML = `${p.qty<=1?`<div class="low-stock-badge">!</div>`:''}<div class="prod-img-container">${visual}</div><div class="prod-name">${p.name}</div><div class="prod-price">$${Number(p.price).toFixed(2)}</div>`; grid.appendChild(div); }); }

// STOCK CHECK
function checkStockAndAdd(p) {
    if (p.qty <= 0 && p.saleType !== 'Granel' && p.saleType !== 'Comun') {
        pendingAddStockCode = p.code;
        document.getElementById('swName').innerText = p.name;
        document.getElementById('swQty').innerText = p.qty;
        document.getElementById('swAdd').value = '';
        document.getElementById('stockWarningModal').style.display = 'flex';
        setTimeout(() => document.getElementById('swAdd').focus(), 100);
    } else { addToCart(p.code); }
}
function resolveStockWarning() { const add = parseFloat(document.getElementById('swAdd').value) || 0; if(add > 0) { const p = db.products.find(x => x.code === pendingAddStockCode); if(p) { p.qty += add; saveDB(); showToast(`Stock actualizado`, 'success'); } } addToCart(pendingAddStockCode); document.getElementById('stockWarningModal').style.display = 'none'; renderCatalog(); }
function ignoreStockWarning() { addToCart(pendingAddStockCode); document.getElementById('stockWarningModal').style.display = 'none'; }

function checkSearchEnter(e) {
    if (e.key === 'Enter') {
        const term = document.getElementById('catalogSearch').value.trim(); if (!term) return;
        const exact = db.products.find(p => p.code === term);
        if (exact) { checkStockAndAdd(exact); document.getElementById('catalogSearch').value = ''; return; }
        document.getElementById('qaCode').innerText = term; document.getElementById('qaName').value = ''; document.getElementById('qaPrice').value = ''; document.getElementById('quickAddProductModal').style.display = 'flex'; setTimeout(()=>document.getElementById('qaName').focus(),100);
    }
}
function saveQuickProduct() {
    const code = document.getElementById('qaCode').innerText; const name = document.getElementById('qaName').value; const price = parseFloat(document.getElementById('qaPrice').value); if(!name || !price) return showToast('Datos incompletos','error');
    db.products.push({ code, name, price, qty: 1, saleType: 'Unidad', dept: 'General' }); saveDB(); document.getElementById('quickAddProductModal').style.display = 'none'; addToCart(code); document.getElementById('catalogSearch').value = ''; renderCatalog(); showToast('Producto creado','success');
}
function confirmCommonItem() { const price = parseFloat(document.getElementById('commonPrice').value); if(!price || price<=0) return showToast('Precio inv√°lido','error'); const t = getCurrentTicket(); t.items.push({ code: 'COM-'+Date.now(), name: 'Producto Com√∫n', price: price, qty: 1, saleType: 'Comun' }); saveDB(); renderCart(); document.getElementById('commonItemModal').style.display='none'; document.getElementById('commonPrice').value = ''; }

function addToCart(code) { const p = db.products.find(x => x.code === code); if(!p) return; if (p.saleType === 'Granel' || p.saleType === 'Kilo') openBulkModal(p); else { const t = getCurrentTicket(); const item = t.items.find(i => i.code === code); if(item) item.qty++; else t.items.push({ ...p, qty: 1 }); saveDB(); renderCart(); } }
function openBulkModal(p) { pendingBulkCode = p.code; document.getElementById('bulkName').innerText = p.name; document.getElementById('bulkPrice').innerText = `$${p.price} / kg`; document.getElementById('bulkQtyInput').value = ''; document.getElementById('bulkTotalDisplay').innerText = 'Total: $0.00'; document.getElementById('bulkModal').style.display = 'flex'; setTimeout(()=>document.getElementById('bulkQtyInput').focus(), 100); }
function calcBulkTotal() { const qty = parseFloat(document.getElementById('bulkQtyInput').value) || 0; const p = db.products.find(x => x.code === pendingBulkCode); if(p) document.getElementById('bulkTotalDisplay').innerText = 'Total: $' + (qty * p.price).toFixed(2); }
function confirmBulkAdd() { const qty = parseFloat(document.getElementById('bulkQtyInput').value) || 0; if(qty <= 0) return showToast("Cantidad inv√°lida",'error'); const p = db.products.find(x => x.code === pendingBulkCode); const t = getCurrentTicket(); const item = t.items.find(i => i.code === pendingBulkCode); if(item) item.qty += qty; else t.items.push({ ...p, qty: qty }); saveDB(); document.getElementById('bulkModal').style.display = 'none'; renderCart(); }
function renderCart() { const t = getCurrentTicket(); document.getElementById('activeTicketLabel').innerText = t.name; const list = document.getElementById('cartList'); list.innerHTML = ''; let total = 0; t.items.forEach((i, idx) => { total += i.price * i.qty; const isBulk = (i.saleType === 'Granel' || i.saleType === 'Kilo'); const row = document.createElement('div'); row.className = 'cart-item'; row.innerHTML = `<div class="cart-info"><span class="cart-name">${i.name}</span><span class="cart-price">$${i.price} x ${isBulk ? i.qty.toFixed(3) : i.qty} ${isBulk?'kg':''}</span></div>${!isBulk ? `<div class="qty-control"><button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button><span class="qty-val">${i.qty}</span><button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button></div>` : ''}<div class="cart-total-item">$${(i.price*i.qty).toFixed(2)}</div><button class="cart-btn-remove" onclick="removeFromCart(${idx})">√ó</button>`; list.appendChild(row); }); document.getElementById('lblTotal').innerText = '$' + total.toFixed(2); }
function updateQty(idx, delta) { const t = getCurrentTicket(); t.items[idx].qty += delta; if(t.items[idx].qty <= 0) t.items.splice(idx, 1); saveDB(); renderCart(); }
function removeFromCart(idx) { const t = getCurrentTicket(); t.items.splice(idx,1); saveDB(); renderCart(); }
function openCobrarModal() { const t = getCurrentTicket(); if(t.items.length===0) return showToast("Carrito vac√≠o",'error'); const total = t.items.reduce((a,b)=>a+(b.price*b.qty),0); document.getElementById('chargeTotalLabel').innerText = '$'+total.toFixed(2); setPaymentMethod('efectivo'); const input = document.getElementById('chargeCashInput'); input.value = total.toFixed(2); const sel = document.getElementById('creditClientSel'); sel.innerHTML = '<option value="">Seleccione...</option>'; db.clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`); document.getElementById('chargeModal').style.display='flex'; setTimeout(()=> { input.focus(); input.select(); calcChange(); }, 100); }
function closeCobrarModal() { document.getElementById('chargeModal').style.display='none'; }
function setPaymentMethod(m) { currentPaymentMethod = m; document.getElementById('btnCash').classList.remove('active'); document.getElementById('btnCard').classList.remove('active'); document.getElementById('btnCredit').classList.remove('active'); document.getElementById('creditSection').style.display = 'none'; document.getElementById('cashInputGroup').style.display = 'block'; document.getElementById('chargeChangeLabel').style.display = 'block'; if(m==='efectivo') { document.getElementById('btnCash').classList.add('active'); document.getElementById('chargeCashInput').disabled=false; } else if(m==='tarjeta') { document.getElementById('btnCard').classList.add('active'); document.getElementById('chargeCashInput').disabled=true; document.getElementById('chargeCashInput').value=''; document.getElementById('chargeChangeLabel').innerText = 'Pago Tarjeta'; } else if(m==='credito') { document.getElementById('btnCredit').classList.add('active'); document.getElementById('creditSection').style.display = 'block'; document.getElementById('cashInputGroup').style.display = 'none'; document.getElementById('chargeChangeLabel').style.display = 'none'; } }
function calcChange(){ if(currentPaymentMethod!=='efectivo') return; const t = getCurrentTicket(); const total = t.items.reduce((a,b)=>a+(b.price*b.qty),0); const c = parseFloat(document.getElementById('chargeCashInput').value)||0; document.getElementById('chargeChangeLabel').innerText = 'Cambio: $' + Math.max(0, c-total).toFixed(2); }
function finalizeSale(print) { const t = getCurrentTicket(); const total = t.items.reduce((a,b)=>a+(b.price*b.qty),0); if(currentPaymentMethod === 'credito') { const clientId = document.getElementById('creditClientSel').value; if(!clientId) return showToast('Selecciona un cliente', 'error'); const client = db.clients.find(c => c.id == clientId); client.debt += total; client.history.push({ date: new Date(), items: [...t.items], total: total, status: 'pending' }); t.items.forEach(item => { const p=db.products.find(x=>x.code===item.code); if(p) p.qty -= item.qty; }); t.items = []; saveDB(); renderCart(); closeCobrarModal(); showToast(`Fiado a ${client.name}`, 'success'); return; } const cash = parseFloat(document.getElementById('chargeCashInput').value)||0; if(currentPaymentMethod==='efectivo' && cash<total) return showToast('Falta efectivo','error'); t.items.forEach(item => { const p=db.products.find(x=>x.code===item.code); if(p) p.qty -= item.qty; }); const sale = { id: Date.now(), date: new Date(), items: [...t.items], total: total, method: currentPaymentMethod, cashGiven: cash, user: db.session.user }; db.sales.push(sale); t.items = []; saveDB(); if(print) { generateTicket(sale); setTimeout(() => { window.print(); finishReset(); }, 500); } else { finishReset(); } }
function finishReset() { renderCart(); renderCatalog(); closeCobrarModal(); showToast('Venta realizada','success'); }

/* ================= CLIENTS ================= */
function renderClients() {
    const div = document.getElementById('clientsList'); div.innerHTML = '';
    db.clients.forEach((c, idx) => {
        const hasDebt = c.debt > 0.5;
        div.innerHTML += `
        <div class="client-card ${hasDebt?'debtor':'clean'}">
            <div><div style="font-weight:bold; font-size:16px">${c.name}</div><div style="font-size:12px; color:#666">Tel: ${c.phone || '-'}</div></div>
            <div style="text-align:right"><div style="font-size:11px; color:#666">Deuda</div><div class="client-balance ${hasDebt?'debt':''}">${hasDebt ? '$'+c.debt.toFixed(2) : 'Al d√≠a'}</div>
                <div style="display:flex; gap:5px; margin-top:5px; justify-content:flex-end">
                    <button class="btn-icon" style="background:#E3F2FD; color:#1565C0; font-size:11px; padding:4px 8px" onclick="viewClientDetails(${c.id})">üëÅÔ∏è Ver Detalle</button>
                    ${hasDebt ? `<button class="btn-icon" style="background:var(--success); color:white; font-size:11px; padding:4px 8px" onclick="openAbonoModal(${c.id})">Abonar</button>` : ''}
                    <button class="btn-icon" style="background:#FFEBEE; color:var(--danger); font-size:11px; padding:4px 8px" onclick="deleteClient(${idx})">üóëÔ∏è</button>
                </div>
            </div>
        </div>`;
    });
}
function deleteClient(idx) { if(confirm('¬øEliminar cliente definitivamente?')) { db.clients.splice(idx,1); saveDB(); renderClients(); showToast('Cliente eliminado','success'); } }
function addClient() { const name = document.getElementById('newCliName').value; const phone = document.getElementById('newCliPhone').value; const limit = parseFloat(document.getElementById('newCliLimit').value)||0; if(!name) return showToast('Nombre obligatorio','error'); db.clients.push({ id: Date.now(), name, phone, limit, debt: 0, history: [] }); saveDB(); renderClients(); document.getElementById('addClientForm').style.display='none'; document.getElementById('newCliName').value=''; showToast('Cliente registrado','success'); }

let viewingClientId = null;
function viewClientDetails(id) {
    viewingClientId = id;
    const c = db.clients.find(x=>x.id===id);
    document.getElementById('detailClientName').innerText = c.name;
    document.getElementById('detailTotal').innerText = 'Total: $'+c.debt.toFixed(2);
    const list = document.getElementById('detailList');
    let items = [];
    c.history.filter(h => h.status === 'pending').forEach(h => { h.items.forEach(i => items.push({...i, date: h.date})); });
    if(items.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#666">Sin productos pendientes</div>'; } 
    else { list.innerHTML = `<table class="detail-table"><thead><tr><th>Fecha</th><th>Cant.</th><th>Prod</th><th>Total</th></tr></thead><tbody>${items.map(i => `<tr><td>${new Date(i.date).toLocaleDateString()}</td><td>${i.qty}</td><td>${i.name}</td><td>$${(i.qty*i.price).toFixed(2)}</td></tr>`).join('')}</tbody></table>`; }
    document.getElementById('clientDetailModal').style.display='block';
}
function manualClearHistory() {
    if(!viewingClientId) return;
    if(!confirm('¬øEst√°s seguro de borrar la deuda y el historial?')) return;
    const c = db.clients.find(x=>x.id===viewingClientId);
    c.debt = 0; c.history = []; saveDB(); renderClients(); document.getElementById('clientDetailModal').style.display='none'; showToast('Historial borrado', 'success');
}
function openAbonoModal(id) { abonoClientId = id; const c = db.clients.find(x=>x.id===id); document.getElementById('abonoClientName').innerText = c.name; document.getElementById('abonoCurrentDebt').innerText = '$'+c.debt.toFixed(2); document.getElementById('abonoAmount').value = ''; document.getElementById('abonoModal').style.display='flex'; document.getElementById('abonoAmount').focus(); }
function processAbono() {
    const amt = parseFloat(document.getElementById('abonoAmount').value); if(!amt || amt<=0) return showToast('Monto inv√°lido','error'); const c = db.clients.find(x=>x.id===abonoClientId); if(amt > c.debt + 0.5) return showToast('Excede deuda','error');
    c.debt -= amt;
    db.movements.push({ date: new Date(), type: 'entrada', amount: amt, reason: `Abono: ${c.name}`, user: db.session.user });
    if(c.debt <= 0.5) { c.debt = 0; printLiquidationTicket(c); c.history = []; showToast('¬°Cuenta liquidada!', 'success'); }
    saveDB(); renderClients(); document.getElementById('abonoModal').style.display='none'; if(c.debt > 0) showToast('Abono registrado','success');
}
function printLiquidationTicket(client) {
    let allItems = []; client.history.filter(h => h.status==='pending').forEach(h => { allItems = [...allItems, ...h.items]; });
    const t = document.getElementById('printableTicket'); t.innerHTML = `<div class="t-header"><div class="t-bold">LIQUIDACI√ìN</div><div>${new Date().toLocaleString()}</div><div>${client.name}</div></div><div class="t-divider"></div>${allItems.map(i=>`<div class="t-line"><span>${i.qty} x ${i.name.substring(0,15)}</span><span>$${(i.qty*i.price).toFixed(2)}</span></div>`).join('')}<div class="t-divider"></div><div class="t-center">¬°CUENTA PAGADA!</div>`; setTimeout(() => window.print(), 500);
}

/* ================= END SHIFT ================= */
function openEndShift() {
    const openT = db.activeTickets.find(t => t.items.length > 0); if(openT) { document.getElementById('acTicketName').innerText = openT.name; const sel = document.getElementById('acClientSel'); sel.innerHTML = ''; db.clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`); document.getElementById('autoCreditModal').style.display='flex'; return; }
    const today = new Date().toLocaleDateString(); const daySales = db.sales.filter(s => new Date(s.date).toLocaleDateString() === today); const dayMoves = db.movements.filter(m => new Date(m.date).toLocaleDateString() === today); const init = parseFloat(db.session.cash || 0); const salesCash = daySales.filter(s => s.method==='efectivo').reduce((a,b)=>a+b.total,0); const entries = dayMoves.filter(m => m.type==='entrada').reduce((a,b)=>a+b.amount,0); const exits = dayMoves.filter(m => m.type==='salida').reduce((a,b)=>a+b.amount,0);
    document.getElementById('cutInitial').innerText = '$'+init.toFixed(2); document.getElementById('cutSales').innerText = '$'+salesCash.toFixed(2); document.getElementById('cutIn').innerText = '$'+entries.toFixed(2); document.getElementById('cutOut').innerText = '$'+exits.toFixed(2); document.getElementById('cutFinal').innerText = '$'+(init+salesCash+entries-exits).toFixed(2);
    document.getElementById('endShiftModal').style.display='flex';
}
function confirmAutoCredit() { const openT = db.activeTickets.find(t => t.items.length > 0); const clientId = document.getElementById('acClientSel').value; if(!clientId) return showToast('Selecciona cliente','error'); const c = db.clients.find(x => x.id == clientId); const total = openT.items.reduce((a,b)=>a+(b.price*b.qty),0); c.debt += total; c.history.push({ date: new Date(), items: [...openT.items], total: total, status: 'pending' }); openT.items.forEach(item => { const p=db.products.find(x=>x.code===item.code); if(p) p.qty -= item.qty; }); openT.items = []; saveDB(); renderCart(); document.getElementById('autoCreditModal').style.display='none'; showToast('Ticket movido a deuda', 'success'); }
function printAndCloseShift() { const t = document.getElementById('printableTicket'); t.innerHTML = `<div class="t-header"><div class="t-bold">CORTE DE CAJA</div><div>${new Date().toLocaleString()}</div><div>Cajero: ${db.session.user}</div></div><div class="t-divider"></div>${document.querySelector('#endShiftModal .form-group').innerHTML}`; window.print(); setTimeout(() => { if(confirm("¬øCerrar turno?")) { db.session.cash = null; db.session.user = null; saveDB(); location.reload(); } }, 1000); }

/* ================= REPORTES & GRAFICAS ================= */
function renderCajaDashboard() {
    const today = new Date().toLocaleDateString(); const daySales = db.sales.filter(s => new Date(s.date).toLocaleDateString() === today); const dayMoves = db.movements.filter(m => new Date(m.date).toLocaleDateString() === today); const salesTotal = daySales.reduce((a,b)=>a+b.total,0); const salesCash = daySales.filter(s => s.method==='efectivo').reduce((a,b)=>a+b.total,0); const entries = dayMoves.filter(m => m.type==='entrada').reduce((a,b)=>a+b.amount,0); const exits = dayMoves.filter(m => m.type==='salida').reduce((a,b)=>a+b.amount,0); const init = parseFloat(db.session.cash || 0);
    document.getElementById('cajaVentasHoy').innerText = '$' + salesTotal.toFixed(2); document.getElementById('cajaEfectivo').innerText = '$' + (init+salesCash+entries-exits).toFixed(2);
}
function renderAnalytics(period, btn) { 
    if(btn) { document.querySelectorAll('.chart-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); } 
    const now = new Date(); let labels = []; let data = []; let labelText = "";
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

    if(period === 'dia') { 
        labelText = now.toLocaleDateString('es-MX', options);
        for(let i=8; i<=22; i++) labels.push(i+':00'); data = new Array(labels.length).fill(0); 
        db.sales.filter(s => new Date(s.date).toLocaleDateString() === now.toLocaleDateString()).forEach(s => { const h = new Date(s.date).getHours(); if(h>=8 && h<=22) data[h-8] += s.total; }); 
    } else if (period === 'semana') { 
        labelText = "√öltima Semana";
        for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(now.getDate() - i); labels.push(d.toLocaleDateString('es-MX',{weekday:'short'})); data.push(0); } 
        db.sales.forEach(s => { const diff = Math.floor((now - new Date(s.date)) / (1000*60*60*24)); if(diff < 7) data[6-diff] += s.total; }); 
    } else { 
        labelText = now.toLocaleDateString('es-MX', {month:'long', year:'numeric'});
        const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate(); for(let i=1; i<=daysInMonth; i++) labels.push(i); data = new Array(labels.length).fill(0); 
        db.sales.filter(s => new Date(s.date).getMonth() === now.getMonth()).forEach(s => { data[new Date(s.date).getDate()-1] += s.total; }); 
    } 
    
    document.getElementById('chartDateLabel').innerText = labelText.charAt(0).toUpperCase() + labelText.slice(1);
    const max = Math.max(...data, 1); document.getElementById('barChart').innerHTML = labels.map((l, i) => `<div class="bar-group"><div class="bar" style="height:${(data[i]/max)*100}%"><div class="bar-val">${data[i]>0 ? '$'+Math.floor(data[i]) : ''}</div></div><div class="bar-label">${l}</div></div>`).join(''); 
    let prodMap = {}; db.sales.forEach(s => s.items.forEach(i => { if(!prodMap[i.name]) prodMap[i.name] = { qty:0, total:0 }; prodMap[i.name].qty += i.qty; prodMap[i.name].total += (i.price * i.qty); })); const top = Object.entries(prodMap).sort((a,b) => b[1].qty - a[1].qty).slice(0, 5); document.getElementById('topProductsList').innerHTML = top.map(x => `<tr><td>${x[0]}</td><td style="text-align:right">${x[1].qty}</td><td style="text-align:right">$${x[1].total.toFixed(2)}</td></tr>`).join(''); 
}
function populateDeptFilter() { const depts = [...new Set(db.products.map(p => p.dept))].filter(Boolean).sort(); const sel = document.getElementById('filterDept'); sel.innerHTML = '<option value="">Todos Deptos</option>' + depts.map(d => `<option value="${d}">${d}</option>`).join(''); }
function renderInvTable() { const tbody = document.querySelector('#invTable tbody'); const term = document.getElementById('invSearch').value.toLowerCase(); const dept = document.getElementById('filterDept').value; const filtered = db.products.filter(p => (p.name.toLowerCase().includes(term) || p.code.includes(term)) && (dept === "" || p.dept === dept)); const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1; if (currentInvPage > totalPages) currentInvPage = totalPages; if (currentInvPage < 1) currentInvPage = 1; const paginated = filtered.slice((currentInvPage - 1) * itemsPerPage, currentInvPage * itemsPerPage); tbody.innerHTML = paginated.map(p => `<tr><td><div style="display:flex; gap:5px"><button class="btn-icon" style="background:#E3F2FD;color:#1565C0" onclick="openEditModal('${p.code}')">‚úèÔ∏è</button><button class="btn-icon" style="background:#FFEBEE;color:#D32F2F" onclick="quickDelete('${p.code}')">üóëÔ∏è</button></div></td><td style="font-family:monospace;color:#555">${p.code}</td><td>${p.name}</td><td>$${Number(p.cost||0).toFixed(2)}</td><td style="font-weight:700">$${Number(p.price||0).toFixed(2)}</td><td>${p.dept||'-'}</td><td>${Number(p.qty).toFixed(2)}</td></tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:20px">Sin resultados</td></tr>'; document.getElementById('pageIndicator').innerText = `P√°gina ${currentInvPage} de ${totalPages}`; }
function quickDelete(code) { if(confirm('¬øBorrar producto?')) { db.products = db.products.filter(p => p.code !== code); saveDB(); renderInvTable(); showToast('Producto eliminado','success'); } }
function openSupplierModal() { document.getElementById('supplierModal').style.display='flex'; document.getElementById('supCode').value=''; document.getElementById('supInfo').style.display='none'; document.getElementById('supCode').focus(); }
function handleSupplierScan() { const code = document.getElementById('supCode').value; const p = db.products.find(x => x.code === code); if(p) { document.getElementById('supName').innerText = p.name; document.getElementById('supCurrent').innerText = p.qty; document.getElementById('supQty').value = ''; document.getElementById('supInfo').style.display = 'block'; document.getElementById('supQty').focus(); } else { showToast('Producto no encontrado','error'); } }
function saveSupplierAdd() { const qty = parseFloat(document.getElementById('supQty').value); const code = document.getElementById('supCode').value; const p = db.products.find(x => x.code === code); if(p && qty > 0) { p.qty += qty; saveDB(); showToast(`Agregado: +${qty} (${p.name})`, 'success'); document.getElementById('supInfo').style.display='none'; document.getElementById('supCode').value=''; document.getElementById('supCode').focus(); } }
function openMoveModal() { document.getElementById('moveModal').style.display='flex'; document.getElementById('moveAmount').value=''; document.getElementById('moveReason').value=''; setMoveType('entrada'); }
function closeMoveModal() { document.getElementById('moveModal').style.display='none'; }
function setMoveType(t) { currentMoveType = t; const btnIn = document.getElementById('btnIn'); const btnOut = document.getElementById('btnOut'); if(t==='entrada'){ btnIn.classList.add('active','btn-green'); btnOut.classList.remove('active','btn-red'); } else { btnOut.classList.add('active','btn-red'); btnIn.classList.remove('active','btn-green'); } }
function confirmMovement() { const amt = parseFloat(document.getElementById('moveAmount').value); const reason = document.getElementById('moveReason').value; if(!amt || !reason) return showToast('Datos incompletos','error'); db.movements.push({ date: new Date(), type: currentMoveType, amount: amt, reason: reason, user: db.session.user }); saveDB(); closeMoveModal(); renderCajaDashboard(); showToast('Movimiento guardado','success'); }
function generateTicket(sale) { const t=document.getElementById('printableTicket'); const c=db.config; t.innerHTML = `${c.logo?`<img src="${c.logo}" class="t-logo">`:''}<div class="t-header"><div class="t-bold">${c.bizName}</div><div style="white-space:pre-wrap">${c.ticketHeader}</div><div class="t-divider"></div><div>${new Date(sale.date).toLocaleString()}</div><div>Cajero: ${sale.user||'Admin'}</div></div><div class="t-divider"></div>${sale.items.map(i=>`<div class="t-line"><span>${i.qty} x ${i.name.substring(0,15)}</span><span>$${(i.qty*i.price).toFixed(2)}</span></div>`).join('')}<div class="t-divider"></div><div class="t-line t-bold"><span>TOTAL</span><span>$${sale.total.toFixed(2)}</span></div><div class="t-center" style="margin-top:10px">${c.ticketFooter}</div>`; }
function openEditModal(code) { const p = db.products.find(x => x.code === code); if(!p) return; editingCode = code; document.getElementById('editCode').value = p.code; document.getElementById('editName').value = p.name; document.getElementById('editQty').value = p.qty; document.getElementById('editSaleType').value = p.saleType || 'Unidad'; document.getElementById('editPrice').value = p.price; document.getElementById('editDept').value = p.dept; document.getElementById('editImage').value = p.image || ''; updateImgPreview(); document.getElementById('editProductModal').style.display = 'flex'; }
function closeEditModal() { document.getElementById('editProductModal').style.display='none'; editingCode=null;}
function saveProductChanges() { const idx = db.products.findIndex(p => p.code === editingCode); if(idx === -1) return; db.products[idx].name = document.getElementById('editName').value; db.products[idx].qty = parseFloat(document.getElementById('editQty').value)||0; db.products[idx].saleType = document.getElementById('editSaleType').value; db.products[idx].price = parseFloat(document.getElementById('editPrice').value)||0; db.products[idx].dept = document.getElementById('editDept').value; db.products[idx].image = document.getElementById('editImage').value; saveDB(); renderInvTable(); closeEditModal(); document.getElementById('catalogSearch').value = ''; renderCatalog(); showToast('Producto actualizado','success'); }
function deleteProductFromModal() { if(!confirm('¬øEliminar?')) return; db.products = db.products.filter(p => p.code !== editingCode); saveDB(); renderInvTable(); closeEditModal(); renderCatalog(); showToast('Producto eliminado','success'); }
function autoCategorizeOnEdit() { const name = document.getElementById('editName').value; if(name) document.getElementById('editDept').value = predictCategory(name); }
function handleFileSelect(evt) { const f = evt.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => parseCSV(e.target.result); r.readAsText(f); }
function parseCSV(text) { const sep = text.indexOf(';') > -1 ? ';' : ','; const lines = text.split('\n').filter(l => l.trim() !== ''); const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g, '')); g_csvData = lines.slice(1).map(l => l.split(sep).map(v => v.trim().replace(/"/g, ''))); const fields = ['map-code','map-name','map-price','map-saleType','map-qty','map-cost','map-dept']; fields.forEach(id => { const sel = document.getElementById(id); sel.innerHTML = '<option value="-1">-- Ignorar --</option>'; headers.forEach((h, i) => { const s = h.toLowerCase().includes(id.split('-')[1]) ? 'selected' : ''; sel.innerHTML += `<option value="${i}" ${s}>${h}</option>`; }); }); document.getElementById('mappingSection').style.display = 'block'; }
function cleanNumber(val) { if(!val) return 0; let s = val.toString().replace(/[$\sA-Za-z]/g, '').replace(/,/g, ''); return parseFloat(s) || 0; }
function processImport() { const getIdx = (id) => parseInt(document.getElementById(id).value); const useAI = document.getElementById('autoCategorizeCheck').checked; const useFix = document.getElementById('smartNameCheck').checked; const map = { code: getIdx('map-code'), name: getIdx('map-name'), price: getIdx('map-price'), saleType: getIdx('map-saleType'), qty: getIdx('map-qty'), cost: getIdx('map-cost'), dept: getIdx('map-dept') }; if(map.code === -1 || map.name === -1 || map.price === -1) return showToast('Falta mapear campos obligatorios','error'); g_csvData.forEach(row => { if(row.length <= Math.max(...Object.values(map))) return; let type = 'Unidad'; if(map.saleType > -1) { const val = row[map.saleType].toLowerCase(); if(val.includes('granel') || val.includes('kilo') || val.includes('kg')) type = 'Granel'; } let pName = row[map.name]; if(useFix) pName = smartFormatName(pName); let department = (map.dept > -1) ? row[map.dept] : ''; if(useAI && (!department || department.trim() === '')) department = predictCategory(pName); const p = { code: row[map.code], name: pName, saleType: type, price: cleanNumber(row[map.price]), qty: map.qty>-1 ? cleanNumber(row[map.qty]) : 0, cost: map.cost>-1 ? cleanNumber(row[map.cost]) : 0, dept: department }; const idx = db.products.findIndex(x => x.code === p.code); if(idx >= 0) db.products[idx] = p; else db.products.push(p); }); saveDB(); showToast('Importaci√≥n completada','success'); document.getElementById('mappingSection').style.display = 'none'; showPage('Inventario'); }
function exportInventory() { let csv = "C√≥digo,Nombre,TipoVenta,Costo,Precio,Stock\n"; db.products.forEach(p => csv += `${p.code},"${p.name}",${p.saleType},${p.cost},${p.price},${p.qty}\n`); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "respaldo.csv"; link.click(); }
function prevPage() { if (currentInvPage > 1) { currentInvPage--; renderInvTable(); } }
function nextPage() { if(true) { currentInvPage++; renderInvTable(); } }
function runPredictions() { const list = document.getElementById('predictionList'); list.innerHTML = '<p style="text-align:center">Analizando...</p>'; const now = new Date(); const limit = new Date(); limit.setDate(now.getDate() - 30); let salesMap = {}; db.sales.forEach(s => { if(new Date(s.date) > limit) s.items.forEach(i => { salesMap[i.code] = (salesMap[i.code]||0) + i.qty; }); }); let html = ''; let count = 0; db.products.forEach(p => { const daily = (salesMap[p.code] || 0) / 30; if(daily > 0) { const days = p.qty / daily; if(days < 15) { count++; html += `<div class="pred-card ${days<=3?'crit':days<=7?'warn':'ok'}"><div class="pred-info"><h4>${p.name}</h4><p>Stock: ${p.qty} | Venta/d√≠a: ${daily.toFixed(1)}</p></div><div class="pred-stat"><div class="days">${days.toFixed(1)}</div><div class="label">D√≠as</div></div></div>`; } } }); list.innerHTML = count>0 ? html : '<div style="text-align:center;padding:40px;color:#666">‚úÖ Todo bien surtido</div>'; }
</script>
</body>
</html>