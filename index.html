<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>POS Master - v32 Mobile üì±</title>
<meta name="theme-color" content="#00897B">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inconsolata:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #00897B; 
    --primary-dark: #00695C;
    --bg-app: #F4F6F8;
    --bg-white: #ffffff;
    --text-dark: #1f2937;
    --text-grey: #6b7280;
    --accent: #FF6F00;
    --danger: #D32F2F;
    --success: #388E3C;
    --font: "Poppins", sans-serif;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: var(--font); background: var(--bg-app); color: var(--text-dark); height: 100vh; overflow: hidden; }
  .app { display: flex; height: 100%; }
  input, select, textarea { font-family: var(--font); font-size: 16px; } /* Font 16px prevents zoom on iOS */

  /* TOAST */
  #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 3000; pointer-events: none; width: 90%; max-width: 400px; text-align: center; }
  .toast { background: rgba(30,30,30,0.95); color: white; padding: 12px 20px; border-radius: 50px; margin-top: 10px; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; display: inline-block; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }

  /* SIDEBAR (DESKTOP) */
  .sidebar { width: 240px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; transition: 0.3s; }
  .brand { font-size: 22px; font-weight: 700; margin-bottom: 40px; line-height: 1.2; }
  .nav-menu { flex: 1; display:flex; flex-direction:column; gap:5px; }
  .side-btn { background: transparent; border: none; color: rgba(255,255,255,0.8); width: 100%; text-align: left; padding: 12px 16px; border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
  .side-btn:hover, .side-btn.active { background: rgba(255,255,255,0.15); color: white; font-weight: 600; }
  .logout-btn { margin-top: auto; color: white; cursor: pointer; opacity: 0.9; font-size: 14px; display: flex; gap: 10px; }
  .role-hidden { display: none !important; }

  /* MAIN CONTENT */
  .main { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
  
  /* POS LAYOUT */
  #POS { display: flex; width: 100%; height: 100%; }
  .pos-catalog { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
  .pos-cart { width: 350px; background: var(--bg-white); display: flex; flex-direction: column; border-left: 1px solid #eee; z-index: 20; }
  
  /* MOBILE TOGGLES (Hidden on Desktop) */
  .mobile-pos-tabs { display: none; padding: 10px; gap: 10px; background: var(--primary); }
  .m-tab { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.2); color: white; }
  .m-tab.active { background: white; color: var(--primary); }

  /* TABS & CART */
  .ticket-tabs { display: flex; overflow-x: auto; background: #f3f4f6; padding: 8px 8px 0 8px; gap: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0; }
  .ticket-tab { background: #e0e0e0; padding: 8px 12px; border-radius: 8px 8px 0 0; font-size: 12px; font-weight: 600; color: #666; min-width: 70px; text-align: center; border:1px solid transparent; cursor: pointer; }
  .ticket-tab.active { background: white; color: var(--primary); border-bottom-color: white; }
  .ticket-tab-add { border: none; background: none; font-size: 18px; padding: 0 10px; cursor: pointer; color: #666; }
  
  .cart-content { padding: 15px; display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .cart-items-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
  
  /* PRODUCTS */
  .search-bar-container { background: var(--bg-white); border-radius: var(--radius); padding: 0 15px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border: 1px solid transparent; height: 45px; }
  .search-bar-container:focus-within { border-color:var(--primary); }
  .search-bar-container input { border: none; width: 100%; height: 100%; font-size: 15px; background: transparent; }
  
  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding-bottom: 80px; }
  .product-card { background: var(--bg-white); border-radius: var(--radius); padding: 8px; box-shadow: var(--shadow); cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; border: 1px solid transparent; position:relative; }
  .product-card:active { transform: scale(0.98); }
  .product-card.low-stock { border-color: var(--danger); background: #FFEBEE; }
  .low-stock-badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }

  .prod-img-container { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; border-radius: 8px; overflow: hidden; background: #f9f9f9; }
  .prod-img { width: 100%; height: 100%; object-fit: contain; }
  .prod-icon { font-size: 36px; } 
  .prod-name { font-weight: 600; font-size: 12px; margin-bottom: 2px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 30px; }
  .prod-price { font-weight: 700; font-size: 15px; margin-top: auto; color: var(--primary-dark); }

  /* CART ITEMS */
  .cart-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6; }
  .cart-info { flex: 1; }
  .cart-name { font-weight: 600; font-size: 13px; color: var(--text-dark); }
  .cart-price { font-size: 12px; color: var(--text-grey); }
  .qty-control { display: flex; align-items: center; gap: 10px; background: #f3f4f6; padding: 5px; border-radius: 8px; margin-right: 10px; }
  .qty-btn { width: 28px; height: 28px; border-radius: 6px; border: none; background: white; color: var(--text-dark); cursor: pointer; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .cart-total-item { font-weight: 700; font-size: 14px; color: var(--primary-dark); min-width: 50px; text-align: right; }
  .cart-btn-remove { color: #ef4444; background: none; border: none; font-size: 20px; padding: 0 0 0 10px; }
  
  /* BUTTONS & UI */
  .pay-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  .pay-btn:active { transform: scale(0.98); }
  .pay-method-btn { flex:1; padding:15px; border:1px solid #ddd; background:white; border-radius:8px; cursor:pointer; font-weight:600; display:flex; flex-direction: column; align-items:center; justify-content:center; gap:5px; font-size: 13px; }
  .pay-method-btn.active { border-color:var(--primary); background:#E0F2F1; color:var(--primary-dark); }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
  .btn-ghost { background: white; border: 1px solid #ddd; color: var(--text-dark); }
  .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; display:inline-flex; align-items:center; justify-content:center; }
  .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
  .option-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center; border: 2px solid transparent; }
  
  /* GENERIC PAGES */
  .page-container { padding: 20px; width: 100%; height:100%; overflow-y: auto; display: none; background: var(--bg-app); padding-bottom: 80px; }
  .page-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--text-dark); display:flex; align-items:center; gap:10px; }
  
  /* TABLES */
  .inv-table-container { background: white; border-radius: 12px; padding: 10px; box-shadow: var(--shadow); overflow-x: auto; min-height: 400px; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  thead tr { text-align: left; border-bottom: 2px solid #eee; }
  th { padding: 12px 8px; font-weight: 600; color: var(--text-grey); font-size: 12px; text-transform: uppercase; }
  td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; font-size: 13px; vertical-align: middle; }

  /* CLIENTS & STATS */
  .client-card { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
  .client-card.debtor { border-left-color: var(--danger); }
  .client-card.clean { border-left-color: var(--success); }
  .caja-resumen-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .caja-card-big { background: white; border-radius: 12px; padding: 15px; box-shadow: var(--shadow); border-left: 4px solid #ddd; }
  .caja-val { font-size: 24px; font-weight: 700; color: var(--text-dark); margin-top: 5px; }
  
  /* MODALS */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--text-grey); }
  .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: #fcfcfc; }

  /* --- MOBILE RESPONSIVE RULES --- */
  @media (max-width: 768px) {
    .app { flex-direction: column; }
    
    /* Bottom Navigation */
    .sidebar { width: 100%; height: 60px; flex-direction: row; position: fixed; bottom: 0; left: 0; z-index: 1000; padding: 0; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .brand, .logout-btn { display: none; }
    .nav-menu { flex-direction: row; width: 100%; justify-content: space-around; gap: 0; }
    .side-btn { flex-direction: column; padding: 8px 5px; font-size: 10px; gap: 4px; justify-content: center; color: rgba(255,255,255,0.7); border-radius: 0; width: 100%; text-align: center; margin: 0; }
    .side-btn.active { background: transparent; color: white; font-weight: 700; border-bottom: 3px solid white; }
    
    /* Main Area Offset */
    .main { margin-bottom: 60px; }
    
    /* POS Mobile */
    .mobile-pos-tabs { display: flex; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #POS { flex-direction: column; }
    .pos-catalog, .pos-cart { width: 100%; display: none; padding: 15px; }
    /* Class to toggle views */
    .show-catalog .pos-catalog { display: flex; }
    .show-cart .pos-cart { display: flex; height: 100%; }
    
    .products-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    
    /* Adjust Modals for Mobile */
    .modal-content { padding: 20px; width: 95%; }
    
    /* Adjust Charts */
    .bar-chart { height: 150px; }
    .caja-val { font-size: 20px; }
  }
  
  /* Print Style */
  #printableTicket { display: none; width: 58mm; font-family: var(--mono); font-size: 12px; color: black; background: white; padding: 5px; }
  .t-line { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .t-divider { border-top: 1px dashed black; margin: 8px 0; }
  .t-center { text-align: center; }
  .t-bold { font-weight: bold; }
  @media print { .app, .modal-overlay, #toast-container { display: none !important; } #printableTicket { display: block !important; } }
</style>
</head>
<body>

<div id="toast-container"></div>
<div id="printableTicket"></div>

<div id="loginModal" class="modal-overlay"><div class="modal-content" style="max-width:320px; text-align:center"><h3>üîê Acceso</h3><div class="form-group"><label>Usuario</label><input id="loginUser" type="text" value="admin" style="text-align:center"></div><div class="form-group"><label>Contrase√±a</label><input id="loginPass" type="password" value="1234" style="text-align:center"></div><button class="pay-btn" onclick="handleLogin()">Entrar</button></div></div>

<div id="cashModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>üí∞ Apertura</h3><div class="form-group"><label>Fondo Inicial</label><input id="initialCash" type="number" placeholder="0.00" style="font-size:24px; text-align:center"></div><button class="pay-btn" onclick="handleSetInitialCash()">Iniciar Turno</button></div></div>

<div id="chargeModal" class="modal-overlay" style="display:none">
    <div class="modal-content">
        <h3>Cobrar</h3>
        <div style="text-align:center; margin-bottom:15px"><div style="font-size:12px; color:#666">Total</div><div id="chargeTotalLabel" style="font-size:36px; font-weight:700; color:var(--primary)">$0.00</div></div>
        <div style="display:flex; gap:8px; margin-bottom:15px">
            <button id="btnCash" class="pay-method-btn active" onclick="setPaymentMethod('efectivo')">üíµ Efectivo</button>
            <button id="btnCard" class="pay-method-btn" onclick="setPaymentMethod('tarjeta')">üí≥ Tarjeta</button>
            <button id="btnCredit" class="pay-method-btn" style="border-color:var(--accent); color:var(--accent)" onclick="setPaymentMethod('credito')">ü§ù Cr√©dito</button>
        </div>
        <div id="creditSection" style="display:none; margin-bottom:15px; background:#FFF8E1; padding:10px; border-radius:8px"><label>Cliente:</label><select id="creditClientSel" style="margin-top:5px"></select><button class="btn btn-ghost" style="width:100%; margin-top:5px; font-size:11px" onclick="showPage('Clientes'); closeCobrarModal()">+ Nuevo</button></div>
        <div class="form-group" id="cashInputGroup"><label>Recibido</label><input id="chargeCashInput" type="number" placeholder="$" oninput="calcChange()" style="font-size:24px; font-weight:bold; text-align:center"></div>
        <div style="text-align:center; font-weight:600; margin-bottom:20px; font-size:18px" id="chargeChangeLabel">Cambio: $0.00</div>
        <button class="pay-btn" onclick="finalizeSale(true)">Cobrar (F12)</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="closeCobrarModal()">Cancelar</button>
    </div>
</div>

<div id="stockWarningModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px; text-align:center"><h3 style="color:var(--danger)">‚ö†Ô∏è Sin Stock</h3><p id="swName" style="font-weight:bold"></p><div class="form-group"><label>Surtir Cantidad:</label><input id="swAdd" type="number" style="text-align:center; font-size:20px"></div><button class="pay-btn" onclick="resolveStockWarning()">Surtir y Vender</button><button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="ignoreStockWarning()">Vender As√≠</button></div></div>
<div id="quickAddProductModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>‚ú® Nuevo</h3><p id="qaCode" style="font-weight:bold; color:#666"></p><div class="form-group"><input id="qaName" placeholder="Nombre"></div><div class="form-group"><input id="qaPrice" type="number" placeholder="Precio"></div><button class="pay-btn" onclick="saveQuickProduct()">Guardar</button><button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="document.getElementById('quickAddProductModal').style.display='none'">Cancelar</button></div></div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">POS Master</div>
    <div class="nav-menu">
        <button class="side-btn active" onclick="showPage('POS')">üõí <span>Ventas</span></button>
        <button class="side-btn" onclick="showPage('Clientes')">üë• <span>Clientes</span></button>
        <button class="side-btn" onclick="showPage('Caja')">üí∞ <span>Caja</span></button>
        <button class="side-btn" onclick="showPage('Reportes')">üìä <span>Reportes</span></button>
        <button class="side-btn role-btn" onclick="showPage('Inventario')">üì¶ <span>Stock</span></button>
        <button class="side-btn role-btn" onclick="showPage('Opciones')">‚öôÔ∏è <span>Ajustes</span></button>
    </div>
    <div class="logout-btn" onclick="doLogout()">Salir</div>
  </aside>

  <main class="main">
    <div class="mobile-pos-tabs">
        <button class="m-tab active" onclick="setMobileView('catalog')" id="btnMobileCat">üì¶ Cat√°logo</button>
        <button class="m-tab" onclick="setMobileView('cart')" id="btnMobileCart">üõí Ticket (<span id="mCartCount">0</span>)</button>
    </div>

    <div id="POS" class="show-catalog"> <div class="pos-catalog">
            <div class="search-bar-container"><span>üîç</span><input type="text" id="catalogSearch" placeholder="Buscar / Escanear..." onkeydown="checkSearchEnter(event)" onkeyup="renderCatalog()"></div>
            <div class="products-grid" id="productsGrid"></div>
        </div>
        <div class="pos-cart">
            <div class="ticket-tabs" id="ticketTabs"></div>
            <div class="cart-content">
                <h3 style="margin:0 0 10px 0; font-size:14px; color:#666" id="activeTicketLabel">Ticket 1</h3>
                <div class="cart-items-list" id="cartList"></div>
                <div style="margin-top:auto; padding-top:10px; border-top:2px dashed #eee">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center"><span style="color:#666">Total</span><span id="lblTotal" style="font-size:24px; font-weight:700; color:var(--text-dark)">$0.00</span></div>
                    <button class="pay-btn" onclick="openCobrarModal()">Cobrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="Clientes" class="page-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h2 class="page-title" style="margin:0">Clientes</h2>
            <button class="btn btn-ghost" onclick="document.getElementById('addClientForm').style.display='block'">+ Nuevo</button>
        </div>
        <div id="addClientForm" style="display:none; background:white; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:var(--shadow)">
            <div class="form-group"><input id="newCliName" placeholder="Nombre"></div>
            <div class="form-group"><input id="newCliPhone" placeholder="Tel√©fono"></div>
            <button class="pay-btn" onclick="addClient()">Guardar</button>
        </div>
        <div id="clientsList"></div>
    </div>

    <div id="Caja" class="page-container">
        <h2 class="page-title">Caja</h2>
        <div class="caja-resumen-grid">
            <div class="caja-card-big" style="border-color:var(--primary)"><div class="caja-lbl">Ventas Hoy</div><div class="caja-val" id="cajaVentasHoy">$0.00</div></div>
            <div class="caja-card-big" style="border-color:var(--success)"><div class="caja-lbl">En Caja</div><div class="caja-val" id="cajaEfectivo">$0.00</div></div>
        </div>
        <div class="options-grid">
            <div class="option-card" onclick="openMoveModal()"><div class="option-icon">üìù</div><div class="option-title">Movimiento</div></div>
            <div class="option-card" onclick="openEndShift()" style="border:2px solid var(--text-dark)"><div class="option-icon">üîê</div><div class="option-title">Corte</div></div>
        </div>
    </div>

    <div id="Reportes" class="page-container">
        <h2 class="page-title">Reportes</h2>
        <div class="chart-header"><div class="chart-tabs"><button class="chart-tab active" onclick="renderAnalytics('dia',this)">Hoy</button><button class="chart-tab" onclick="renderAnalytics('semana',this)">Sem</button><button class="chart-tab" onclick="renderAnalytics('mes',this)">Mes</button></div></div>
        <div id="chartDateLabel" style="text-align:center; margin-bottom:10px; font-size:12px; font-weight:600; color:var(--primary)"></div>
        <div style="background:white; padding:15px; border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow)"><div id="barChart" class="bar-chart"></div></div>
        <div style="background:white; padding:15px; border-radius:16px; box-shadow:var(--shadow)"><h3 style="margin:0 0 10px 0">Top Productos</h3><table class="users-table"><thead><tr><th>Prod</th><th style="text-align:right">$$</th></tr></thead><tbody id="topProductsList"></tbody></table></div>
    </div>

    <div id="Inventario" class="page-container">
        <div class="inv-toolbar" style="flex-wrap:wrap">
            <input id="invSearch" type="text" placeholder="Buscar..." onkeyup="currentInvPage=1; renderInvTable()" style="flex:1; min-width:150px; padding:10px; border:1px solid #ddd; border-radius:8px">
            <button class="btn-icon" style="background:#E1F5FE; color:#0277BD" onclick="openSupplierModal()">üöõ</button>
            <button class="btn-icon" style="background:#F3E5F5; color:#7B1FA2" onclick="showPage('Prediccion')">üîÆ</button>
        </div>
        <div class="inv-table-container"><table id="invTable"><thead><tr><th>Acci√≥n</th><th>Prod</th><th>$ Venta</th><th>Stock</th></tr></thead><tbody></tbody></table></div>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:20px"><button class="btn btn-ghost" onclick="prevPage()">Anterior</button><span id="pageIndicator">1</span><button class="btn btn-ghost" onclick="nextPage()">Siguiente</button></div>
    </div>

    <div id="Prediccion" class="page-container"><div style="display:flex; justify-content:space-between; margin-bottom:15px"><h2 class="page-title">Abasto IA</h2><button class="btn btn-ghost" onclick="showPage('Inventario')">Volver</button></div><div id="predictionList"></div></div>

    <div id="Opciones" class="page-container"><h2 class="page-title">Ajustes</h2><div class="options-grid"><div class="option-card" onclick="showPage('Configuracion')"><div class="option-icon">‚öôÔ∏è</div><div class="option-title">Config</div></div><div class="option-card" onclick="showPage('Importar')"><div class="option-icon">üì•</div><div class="option-title">Importar</div></div><div class="option-card" onclick="exportInventory()"><div class="option-icon">üíæ</div><div class="option-title">Respaldo</div></div></div></div>
    
    <div id="Configuracion" class="page-container"><button class="btn btn-ghost" onclick="showPage('Opciones')" style="margin-bottom:15px">‚Üê Volver</button><div class="options-grid"><div class="option-card" onclick="showPage('Cfg_Apariencia')">üé® Apariencia</div><div class="option-card" onclick="showPage('Cfg_Ticket')">üßæ Ticket</div><div class="option-card" onclick="showPage('Cfg_Usuarios')">üë• Usuarios</div></div></div>
    <div id="Cfg_Apariencia" class="page-container"><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button><div class="settings-section"><div class="form-group"><label>Negocio</label><input id="cfgBizName"></div><div class="form-group"><label>Color</label><input id="cfgColor" type="color" onchange="previewColor()"></div><button class="pay-btn" onclick="saveConfig()">Guardar</button></div></div>
    <div id="Cfg_Ticket" class="page-container"><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button><div class="settings-section"><div class="form-group"><label>Encabezado</label><textarea id="cfgHeader" rows="3"></textarea></div><div class="form-group"><label>Pie</label><textarea id="cfgFooter" rows="2"></textarea></div><button class="pay-btn" onclick="saveConfig()">Guardar</button></div></div>
    <div id="Cfg_Usuarios" class="page-container"><button class="btn btn-ghost" onclick="showPage('Configuracion')">‚Üê Volver</button><div class="settings-section"><div class="form-group"><input id="newUserName" placeholder="Usuario"></div><div class="form-group"><input id="newUserPass" placeholder="Clave"></div><div class="form-group"><select id="newUserRole"><option value="cajero">Cajero</option><option value="admin">Admin</option></select></div><button class="pay-btn" onclick="addUser()">Agregar</button><div style="margin-top:20px"><table class="users-table"><thead><tr><th>User</th><th>Rol</th><th>x</th></tr></thead><tbody id="usersList"></tbody></table></div></div></div>
    
    <div id="Importar" class="page-container"><button class="btn btn-ghost" onclick="showPage('Opciones')">‚Üê Volver</button><div class="file-drop-zone" onclick="document.getElementById('csvFileInput').click()" style="margin-top:20px">Subir CSV</div><input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)"><div id="mappingSection" style="display:none; margin-top:20px; background:white; padding:15px; border-radius:12px"><div class="form-group"><label>C√≥digo</label><select id="map-code"></select></div><div class="form-group"><label>Nombre</label><select id="map-name"></select></div><div class="form-group"><label>Precio</label><select id="map-price"></select></div><button class="pay-btn" onclick="processImport()">Importar</button></div></div>

    <div id="abonoModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>Abonar</h3><p id="abonoClientName"></p><p style="color:var(--danger)">Debe: <b id="abonoCurrentDebt"></b></p><div class="form-group"><input id="abonoAmount" type="number" placeholder="$"></div><button class="pay-btn" onclick="processAbono()">Registrar</button><button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="document.getElementById('abonoModal').style.display='none'">Cancelar</button></div></div>
    <div id="clientDetailModal" class="modal-overlay" style="display:none"><div class="modal-content"><h3>Detalle</h3><div id="detailList" style="max-height:300px; overflow:auto; margin-bottom:10px"></div><div id="detailTotal" style="text-align:right; font-weight:bold; margin-bottom:15px"></div><div style="display:flex; gap:10px"><button class="btn btn-ghost" style="color:red" onclick="manualClearHistory()">Borrar</button><button class="btn btn-ghost" onclick="document.getElementById('clientDetailModal').style.display='none'">Cerrar</button></div></div></div>
    <div id="moveModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>Movimiento</h3><div style="display:flex; gap:10px; margin-bottom:15px"><button id="btnIn" class="pay-method-btn" onclick="setMoveType('entrada')">Entrada</button><button id="btnOut" class="pay-method-btn" onclick="setMoveType('salida')">Salida</button></div><div class="form-group"><input id="moveAmount" type="number" placeholder="Monto"></div><div class="form-group"><input id="moveReason" placeholder="Motivo"></div><button class="pay-btn" onclick="confirmMovement()">Guardar</button><button class="btn btn-ghost" style="width:100%" onclick="closeMoveModal()">Cancelar</button></div></div>
    <div id="endShiftModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:350px"><h3>Corte</h3><div class="form-group" style="font-size:14px"><div class="t-line"><span>Inicial:</span><span id="cutInitial"></span></div><div class="t-line"><span>Ventas:</span><span id="cutSales"></span></div><div class="t-line"><span>Extras:</span><span id="cutIn"></span></div><div class="t-line"><span>Gastos:</span><span id="cutOut"></span></div><div class="t-divider"></div><div class="t-line t-bold"><span>TOTAL:</span><span id="cutFinal"></span></div></div><button class="pay-btn" onclick="printAndCloseShift()">Cerrar Turno</button><button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('endShiftModal').style.display='none'">Cancelar</button></div></div>
    <div id="autoCreditModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>‚ö†Ô∏è Ticket Abierto</h3><p>El ticket "<span id="acTicketName"></span>" se debe fiar para cerrar.</p><select id="acClientSel" style="width:100%; padding:10px; margin-bottom:15px"></select><button class="pay-btn" onclick="confirmAutoCredit()">Guardar Deuda</button><button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('autoCreditModal').style.display='none'">Cancelar</button></div></div>
    <div id="supplierModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:320px"><h3>Recepci√≥n</h3><div class="form-group"><input id="supCode" placeholder="C√≥digo..." onkeydown="if(event.key==='Enter') handleSupplierScan()"></div><div id="supInfo" style="display:none"><p id="supName" style="font-weight:bold"></p><div class="form-group"><input id="supQty" type="number" placeholder="Cantidad" onkeydown="if(event.key==='Enter') saveSupplierAdd()"></div><button class="pay-btn" onclick="saveSupplierAdd()">Confirmar</button></div><button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('supplierModal').style.display='none'">Cerrar</button></div></div>
    <div id="commonItemModal" class="modal-overlay" style="display:none"><div class="modal-content" style="max-width:300px"><h3>Com√∫n</h3><input id="commonPrice" type="number" placeholder="$" style="font-size:24px; text-align:center; width:100%; margin-bottom:15px" onkeydown="if(event.key==='Enter') confirmCommonItem()"><button class="pay-btn" onclick="confirmCommonItem()">Agregar</button></div></div>
  </main>
</div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = { apiKey: "AIzaSyA61-NvaXsIqCJAlkYockyhNOn9jBfq4d0", authDomain: "posmaster-b7ee3.firebaseapp.com", projectId: "posmaster-b7ee3", storageBucket: "posmaster-b7ee3.firebasestorage.app", messagingSenderId: "218428018122", appId: "1:218428018122:web:c32565fde06f2ba3fc9333" };
let dbFire=null; try{ firebase.initializeApp(firebaseConfig); dbFire=firebase.firestore(); }catch(e){}

/* ================= CORE ================= */
const MAIN_KEY='abarrotes_master_db'; const LEGACY_KEYS=['abarrotes_pos_v17'];
const db_defaults={ products:[], sales:[], movements:[], clients:[], activeTickets:[{id:1,name:'Ticket 1',items:[]}], users:[{name:'admin',pass:'1234',role:'admin'}], config:{ bizName:'Mi Tienda', color:'#00897B', ticketHeader:'', ticketFooter:'', logo:''}, session:{ user:null, role:null, cash:null, currentTicketId:1 } };
let db={...db_defaults}, currentInvPage=1, currentPaymentMethod='efectivo', pendingBulkCode=null, currentMoveType='entrada', abonoClientId=null, pendingAddStockCode=null;

/* ================= HELPERS ================= */
function showToast(msg,type='neutral'){ const c=document.getElementById('toast-container'); const t=document.createElement('div'); t.className=`toast ${type}`; t.innerHTML=type==='success'?'‚úÖ '+msg:type==='error'?'‚ùå '+msg:msg; c.appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300)},3000); }
function getSmartEmoji(n){ const l=n.toLowerCase(); if(l.includes('coca'))return'ü•§'; if(l.includes('leche'))return'ü•õ'; if(l.includes('sabrit'))return'üçü'; return'üì¶'; }
function adjustColor(c,a){ return '#'+c.replace(/^#/,'').replace(/../g,c=>('0'+Math.min(255,Math.max(0,parseInt(c,16)+a)).toString(16)).substr(-2)); }

/* ================= LOAD & SYNC ================= */
async function loadDB(){
    let raw=localStorage.getItem(MAIN_KEY); if(!raw){ for(const k of LEGACY_KEYS){ const d=localStorage.getItem(k); if(d){ raw=d; break;}}}
    if(raw){ try{ const s=JSON.parse(raw); db={...db_defaults,...s, config:{...db_defaults.config,...(s.config||{})}, session:{...db_defaults.session,...s.session}}; if(!db.activeTickets.length) db.activeTickets=[{id:1,name:'Ticket 1',items:[]}]; initUI(); }catch(e){ console.log(e); }} else { initUI(); }
    if(dbFire){ try{ const d=await dbFire.collection("tiendas").doc("mi_sucursal").get(); if(d.exists){ const c=d.data(); const ses=db.session; db={...db_defaults,...c}; db.session=ses; localStorage.setItem(MAIN_KEY,JSON.stringify(db)); showToast("Sincronizado","cloud"); initUI(); } }catch(e){} }
}
function saveDB(){ localStorage.setItem(MAIN_KEY,JSON.stringify(db)); if(dbFire) dbFire.collection("tiendas").doc("mi_sucursal").set(JSON.parse(JSON.stringify(db))).catch(()=>{}); }
function initUI(){
    applyConfigUI();
    if(db.session.user){ 
        document.getElementById('loginModal').style.display='none'; 
        checkRoleUI(db.session.role||'admin'); 
        if(!db.session.cash) document.getElementById('cashModal').style.display='flex'; 
        else { renderCatalog(); renderTabs(); renderCart(); setupKeyboard(); }
    } else document.getElementById('loginModal').style.display='flex';
}
window.onload=loadDB;

/* ================= MOBILE VIEW LOGIC ================= */
function setMobileView(view){
    const pos = document.getElementById('POS');
    const btnCat = document.getElementById('btnMobileCat');
    const btnCart = document.getElementById('btnMobileCart');
    if(view === 'catalog'){
        pos.classList.remove('show-cart'); pos.classList.add('show-catalog');
        btnCat.classList.add('active'); btnCart.classList.remove('active');
    } else {
        pos.classList.remove('show-catalog'); pos.classList.add('show-cart');
        btnCart.classList.add('active'); btnCat.classList.remove('active');
    }
}

/* ================= POS & TICKETS ================= */
function getCurrentTicket(){ let t=db.activeTickets.find(x=>x.id===db.session.currentTicketId); if(!t){ t=db.activeTickets[0]; db.session.currentTicketId=t.id; } return t; }
function renderTabs(){ 
    const c=document.getElementById('ticketTabs'); c.innerHTML=''; 
    db.activeTickets.forEach(t=>{ 
        const d=document.createElement('div'); d.className=`ticket-tab ${t.id===db.session.currentTicketId?'active':''}`; 
        d.innerHTML=`<span ondblclick="renameTab(${t.id})">${t.name}</span>${db.activeTickets.length>1?`<span class="ticket-tab-close" onclick="closeTab(${t.id},event)">‚úï</span>`:''}`; 
        d.onclick=(e)=>{ if(!e.target.classList.contains('ticket-tab-close')){ db.session.currentTicketId=t.id; saveDB(); renderTabs(); renderCart(); } }; 
        c.appendChild(d); 
    });
    const b=document.createElement('button'); b.className='ticket-tab-add'; b.innerText='+'; 
    b.onclick=()=>{ const nid=Date.now(); db.activeTickets.push({id:nid, name:`T-${db.activeTickets.length+1}`, items:[]}); db.session.currentTicketId=nid; saveDB(); renderTabs(); renderCart(); }; c.appendChild(b);
}
function closeTab(id,e){ e.stopPropagation(); const idx=db.activeTickets.findIndex(x=>x.id===id); if(db.activeTickets[idx].items.length>0) return showToast('Ticket con productos','error'); db.activeTickets.splice(idx,1); db.session.currentTicketId=db.activeTickets[0].id; saveDB(); renderTabs(); renderCart(); }
function renameTab(id){ const t=db.activeTickets.find(x=>x.id===id); const n=prompt('Nombre:',t.name); if(n){t.name=n; saveDB(); renderTabs();} }

function renderCatalog(){
    const g=document.getElementById('productsGrid'); g.innerHTML=''; 
    const term=document.getElementById('catalogSearch').value.toLowerCase();
    const f=db.products.filter(p=>p.name.toLowerCase().includes(term)||p.code.includes(term)).slice(0,50);
    f.forEach(p=>{
        const d=document.createElement('div'); d.className=`product-card ${p.qty<=1?'low-stock':''}`; d.onclick=()=>checkStockAndAdd(p);
        d.innerHTML=`${p.qty<=1?'<div class="low-stock-badge">!</div>':''}<div class="prod-img-container">${p.image&&p.image.length>10?`<img src="${p.image}" class="prod-img">`:`<div class="prod-icon">${getSmartEmoji(p.name)}</div>`}</div><div class="prod-name">${p.name}</div><div class="prod-price">$${p.price}</div>`;
        g.appendChild(d);
    });
}
function checkStockAndAdd(p){ if(p.qty<=0 && p.saleType!=='Granel' && p.saleType!=='Comun'){ pendingAddStockCode=p.code; document.getElementById('swName').innerText=p.name; document.getElementById('swAdd').value=''; document.getElementById('stockWarningModal').style.display='flex'; } else { addToCart(p.code); } }
function resolveStockWarning(){ const n=parseFloat(document.getElementById('swAdd').value)||0; if(n>0){ const p=db.products.find(x=>x.code===pendingAddStockCode); p.qty+=n; saveDB(); showToast('Stock +'+n,'success'); } addToCart(pendingAddStockCode); document.getElementById('stockWarningModal').style.display='none'; renderCatalog(); }
function ignoreStockWarning(){ addToCart(pendingAddStockCode); document.getElementById('stockWarningModal').style.display='none'; }

function addToCart(code){ const p=db.products.find(x=>x.code===code); if(!p)return; const t=getCurrentTicket(); const i=t.items.find(x=>x.code===code); if(i) i.qty++; else t.items.push({...p, qty:1}); saveDB(); renderCart(); showToast('Agregado'); }
function renderCart(){ 
    const t=getCurrentTicket(); document.getElementById('activeTicketLabel').innerText=t.name; 
    const l=document.getElementById('cartList'); l.innerHTML=''; let tot=0; let count=0;
    t.items.forEach((i,idx)=>{ 
        tot+=i.price*i.qty; count+=i.qty;
        const r=document.createElement('div'); r.className='cart-item'; 
        r.innerHTML=`<div class="cart-info"><div class="cart-name">${i.name}</div><div class="cart-price">$${i.price} x ${i.qty}</div></div><div class="qty-control"><button class="qty-btn" onclick="updQty(${idx},-1)">-</button><span class="qty-val">${i.qty}</span><button class="qty-btn" onclick="updQty(${idx},1)">+</button></div><div class="cart-total-item">$${(i.price*i.qty).toFixed(2)}</div><button class="cart-btn-remove" onclick="rmItem(${idx})">√ó</button>`; 
        l.appendChild(r); 
    }); 
    document.getElementById('lblTotal').innerText='$'+tot.toFixed(2);
    document.getElementById('mCartCount').innerText = count; // Update Mobile Badge
}
function updQty(i,d){ const t=getCurrentTicket(); t.items[i].qty+=d; if(t.items[i].qty<=0) t.items.splice(i,1); saveDB(); renderCart(); }
function rmItem(i){ getCurrentTicket().items.splice(i,1); saveDB(); renderCart(); }

/* ================= PAYMENTS ================= */
function openCobrarModal(){ const t=getCurrentTicket(); if(!t.items.length)return showToast('Vac√≠o','error'); document.getElementById('chargeTotalLabel').innerText='$'+t.items.reduce((a,b)=>a+b.price*b.qty,0).toFixed(2); setPaymentMethod('efectivo'); document.getElementById('chargeCashInput').value=t.items.reduce((a,b)=>a+b.price*b.qty,0); const s=document.getElementById('creditClientSel'); s.innerHTML='<option value="">Seleccione...</option>'; db.clients.forEach(c=>s.innerHTML+=`<option value="${c.id}">${c.name}</option>`); document.getElementById('chargeModal').style.display='flex'; }
function closeCobrarModal(){ document.getElementById('chargeModal').style.display='none'; }
function setPaymentMethod(m){ currentPaymentMethod=m; document.querySelectorAll('.pay-method-btn').forEach(b=>b.classList.remove('active')); if(m==='efectivo') document.getElementById('btnCash').classList.add('active'); if(m==='tarjeta') document.getElementById('btnCard').classList.add('active'); if(m==='credito') document.getElementById('btnCredit').classList.add('active'); document.getElementById('creditSection').style.display=m==='credito'?'block':'none'; document.getElementById('cashInputGroup').style.display=m==='credito'?'none':'block'; document.getElementById('chargeChangeLabel').style.display=m==='credito'?'none':'block'; }
function finalizeSale(print){ 
    const t=getCurrentTicket(); const tot=t.items.reduce((a,b)=>a+b.price*b.qty,0); 
    if(currentPaymentMethod==='credito'){ 
        const cid=document.getElementById('creditClientSel').value; if(!cid) return showToast('Elige cliente','error'); 
        const c=db.clients.find(x=>x.id==cid); c.debt+=tot; c.history.push({date:new Date(), items:[...t.items], total:tot, status:'pending'}); 
        t.items.forEach(i=>{ const p=db.products.find(x=>x.code===i.code); if(p) p.qty-=i.qty; }); 
        t.items=[]; saveDB(); renderCart(); closeCobrarModal(); showToast('Fiado a '+c.name,'success'); return; 
    }
    const cash=parseFloat(document.getElementById('chargeCashInput').value)||0; if(currentPaymentMethod==='efectivo' && cash<tot) return showToast('Falta efectivo','error');
    t.items.forEach(i=>{ const p=db.products.find(x=>x.code===i.code); if(p) p.qty-=i.qty; });
    db.sales.push({id:Date.now(), date:new Date(), items:[...t.items], total:tot, method:currentPaymentMethod, cash:cash, user:db.session.user});
    t.items=[]; saveDB(); if(print){ genTicket(tot,cash); setTimeout(()=>{window.print();finishReset()},500); } else finishReset();
}
function finishReset(){ renderCart(); renderCatalog(); closeCobrarModal(); showToast('Venta OK','success'); setMobileView('catalog'); }
function genTicket(tot,cash){ const t=document.getElementById('printableTicket'); t.innerHTML=`<div class="t-header"><div class="t-bold">${db.config.bizName}</div><div style="white-space:pre-wrap">${db.config.ticketHeader}</div><div class="t-divider"></div><div>${new Date().toLocaleString()}</div></div><div class="t-divider"></div><div class="t-line t-bold"><span>TOTAL</span><span>$${tot.toFixed(2)}</span></div><div class="t-center">${db.config.ticketFooter}</div>`; }

/* ================= CLIENTS & MISC ================= */
function renderClients(){ const d=document.getElementById('clientsList'); d.innerHTML=''; db.clients.forEach((c,i)=>{ d.innerHTML+=`<div class="client-card ${c.debt>0?'debtor':'clean'}"><div><b>${c.name}</b><br><small>${c.phone||''}</small></div><div style="text-align:right"><small>Deuda</small><br><b style="color:${c.debt>0?'red':'green'}">$${c.debt.toFixed(2)}</b><br>${c.debt>0?`<button class="btn-icon" onclick="openAbono(${c.id})" style="background:#e8f5e9">üíµ</button>`:''} <button class="btn-icon" onclick="viewClient(${c.id})" style="background:#e3f2fd">üëÅÔ∏è</button> <button class="btn-icon" onclick="delClient(${i})" style="color:red">üóëÔ∏è</button></div></div>`; }); }
function addClient(){ const n=document.getElementById('newCliName').value; const p=document.getElementById('newCliPhone').value; if(!n)return showToast('Nombre falta','error'); db.clients.push({id:Date.now(), name:n, phone:p, debt:0, history:[]}); saveDB(); renderClients(); document.getElementById('addClientForm').style.display='none'; document.getElementById('newCliName').value=''; }
function delClient(i){ if(confirm('¬øBorrar?')) { db.clients.splice(i,1); saveDB(); renderClients(); } }
function openAbono(id){ abonoClientId=id; const c=db.clients.find(x=>x.id===id); document.getElementById('abonoClientName').innerText=c.name; document.getElementById('abonoCurrentDebt').innerText='$'+c.debt.toFixed(2); document.getElementById('abonoModal').style.display='flex'; }
function processAbono(){ const a=parseFloat(document.getElementById('abonoAmount').value); const c=db.clients.find(x=>x.id===abonoClientId); if(!a || a<=0) return showToast('Monto mal','error'); c.debt-=a; db.movements.push({date:new Date(), type:'entrada', amount:a, reason:'Abono '+c.name, user:db.session.user}); if(c.debt<=0.5){ c.debt=0; c.history=[]; showToast('Pagado!','success'); } saveDB(); renderClients(); document.getElementById('abonoModal').style.display='none'; }
function viewClient(id){ viewingClientId=id; const c=db.clients.find(x=>x.id===id); document.getElementById('detailClientName').innerText=c.name; document.getElementById('detailTotal').innerText='$'+c.debt.toFixed(2); const l=document.getElementById('detailList'); l.innerHTML=c.history.map(h=>h.status==='pending'?`<div>${new Date(h.date).toLocaleDateString()} - $${h.total}</div>`: '').join('')||'Sin historial'; document.getElementById('clientDetailModal').style.display='flex'; }
function manualClearHistory(){ const c=db.clients.find(x=>x.id===viewingClientId); c.debt=0; c.history=[]; saveDB(); renderClients(); document.getElementById('clientDetailModal').style.display='none'; showToast('Borrado','success'); }

/* ================= NAV & UTIL ================= */
function showPage(id){ document.querySelectorAll('.page-container, #POS').forEach(e=>e.style.display='none'); document.getElementById(id).style.display=id==='POS'?'flex':'block'; document.querySelectorAll('.side-btn').forEach(b=>b.classList.remove('active')); if(id==='Inventario') renderInvTable(); if(id==='Reportes') renderAnalytics('dia'); if(id==='Caja') renderCajaDashboard(); if(id==='Clientes') renderClients(); }
function handleLogin(){ const u=document.getElementById('loginUser').value; const p=document.getElementById('loginPass').value; const r=db.users.find(x=>x.name===u && x.pass===p); if(r){ db.session.user=u; db.session.role=r.role; saveDB(); initUI(); } else showToast('Error','error'); }
function doLogout(){ db.session.user=null; saveDB(); location.reload(); }
function applyConfigUI(){ const c=db.config; document.documentElement.style.setProperty('--primary', c.color); document.documentElement.style.setProperty('--primary-dark', adjustColor(c.color,-30)); document.getElementById('brandNameDisplay').innerHTML=c.bizName; document.getElementById('cfgBizName').value=c.bizName; document.getElementById('cfgColor').value=c.color; document.getElementById('cfgHeader').value=c.ticketHeader; document.getElementById('cfgFooter').value=c.ticketFooter; }
function saveConfig(){ db.config.bizName=document.getElementById('cfgBizName').value; db.config.color=document.getElementById('cfgColor').value; db.config.ticketHeader=document.getElementById('cfgHeader').value; db.config.ticketFooter=document.getElementById('cfgFooter').value; saveDB(); applyConfigUI(); showToast('Guardado','success'); }
function checkRoleUI(r){ const d=r==='cajero'?'none':'flex'; document.querySelectorAll('.role-btn').forEach(e=>e.style.display=d); }
function setupKeyboard(){ document.addEventListener('keydown',e=>{ if(e.key==='F10'){e.preventDefault();document.getElementById('catalogSearch').focus()} if(e.key==='F12'){e.preventDefault();openCobrarModal()} if(e.key==='Escape') document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }); }
function checkSearchEnter(e){ if(e.key==='Enter'){ const t=document.getElementById('catalogSearch').value.trim(); if(!t)return; const p=db.products.find(x=>x.code===t); if(p){checkStockAndAdd(p);document.getElementById('catalogSearch').value=''} else{ document.getElementById('qaCode').innerText=t; document.getElementById('quickAddProductModal').style.display='flex'; } } }
function saveQuickProduct(){ const c=document.getElementById('qaCode').innerText; const n=document.getElementById('qaName').value; const p=parseFloat(document.getElementById('qaPrice').value); if(!n||!p)return; db.products.push({code:c,name:n,price:p,qty:1,saleType:'Unidad'}); saveDB(); addToCart(c); document.getElementById('quickAddProductModal').style.display='none'; renderCatalog(); }
// Charts
function renderAnalytics(p,b){ if(b){document.querySelectorAll('.chart-tab').forEach(x=>x.classList.remove('active'));b.classList.add('active')} const now=new Date(); let d=[],l=[]; if(p==='dia'){ document.getElementById('chartDateLabel').innerText=now.toLocaleDateString(); for(let i=8;i<=22;i++){l.push(i+':00');d.push(0)} db.sales.filter(s=>new Date(s.date).getDate()===now.getDate()).forEach(s=>{const h=new Date(s.date).getHours();if(h>=8&&h<=22)d[h-8]+=s.total}); } else if(p==='mes'){ document.getElementById('chartDateLabel').innerText='Este Mes'; const m=new Date(now.getFullYear(),now.getMonth()+1,0).getDate(); for(let i=1;i<=m;i++){l.push(i);d.push(0)} db.sales.filter(s=>new Date(s.date).getMonth()===now.getMonth()).forEach(s=>{d[new Date(s.date).getDate()-1]+=s.total}); } const max=Math.max(...d,1); document.getElementById('barChart').innerHTML=l.map((x,i)=>`<div class="bar-group"><div class="bar" style="height:${(d[i]/max)*100}%"></div><div class="bar-label">${x}</div></div>`).join(''); }
function renderCajaDashboard(){ const t=new Date().toLocaleDateString(); const s=db.sales.filter(x=>new Date(x.date).toLocaleDateString()===t).reduce((a,b)=>a+b.total,0); document.getElementById('cajaVentasHoy').innerText='$'+s.toFixed(2); document.getElementById('cajaEfectivo').innerText='$'+(parseFloat(db.session.cash||0)+s).toFixed(2); }
function openEndShift(){ document.getElementById('endShiftModal').style.display='flex'; }
function printAndCloseShift(){ db.session.cash=null; db.session.user=null; saveDB(); location.reload(); }
function openSupplierModal(){ document.getElementById('supplierModal').style.display='flex'; }
function saveSupplierAdd(){ const q=parseFloat(document.getElementById('supQty').value); const c=document.getElementById('supCode').value; const p=db.products.find(x=>x.code===c); if(p){ p.qty+=q; saveDB(); showToast('Stock OK','success'); document.getElementById('supplierModal').style.display='none'; } }
function renderInvTable(){ const b=document.querySelector('#invTable tbody'); const t=document.getElementById('invSearch').value.toLowerCase(); const p=db.products.filter(x=>x.name.toLowerCase().includes(t)).slice(0,50); b.innerHTML=p.map(x=>`<tr><td><button onclick="openEditModal('${x.code}')">‚úèÔ∏è</button></td><td>${x.name}</td><td>$${x.price}</td><td>${x.qty}</td></tr>`).join(''); }
function handleFileSelect(e){ const r=new FileReader(); r.onload=x=>parseCSV(x.target.result); r.readAsText(e.target.files[0]); }
function parseCSV(t){ t.split('\n').slice(1).forEach(l=>{ const c=l.split(','); if(c.length>2) db.products.push({code:c[0],name:c[1],price:parseFloat(c[2]),qty:parseFloat(c[3])||0,saleType:'Unidad'})}); saveDB(); showToast('Importado','success'); }
function exportInventory(){ const c="C√≥digo,Nombre,Precio,Stock\n"+db.products.map(p=>`${p.code},${p.name},${p.price},${p.qty}`).join('\n'); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURI(c); a.download='stock.csv'; a.click(); }
</script>
</body>
</html>

